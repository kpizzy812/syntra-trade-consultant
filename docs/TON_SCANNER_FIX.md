# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ TON Scanner

## –ü—Ä–æ–±–ª–µ–º–∞

TON —Å–∫–∞–Ω–µ—Ä –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –Ω–µ–≤–µ—Ä–Ω—ã–º memo, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∑–∞—Å–æ—Ä–µ–Ω–∏—é –ª–æ–≥–æ–≤:

```
2025-11-18 23:07:53 | DEBUG | –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π memo: @SYNTRATRADEBOT PAYOUT
2025-11-18 23:07:53 | INFO  | üîç TON Scan: 1 –Ω–æ–≤—ã—Ö TX | ‚ö†Ô∏è 1 —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ | 0.4—Å
```

### –ü—Ä–∏—á–∏–Ω–∞

1. `last_lt` (logical time) —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `payments` –ø—Ä–∏ **—É—Å–ø–µ—à–Ω–æ–π** –æ–±—Ä–∞–±–æ—Ç–∫–µ
2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º memo (–Ω–µ –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è —Å "PAY_") –æ—Ç–∫–ª–æ–Ω—è–ª–∏—Å—å –∏ –ù–ï —Å–æ–∑–¥–∞–≤–∞–ª–∏ Payment –∑–∞–ø–∏—Å–∏
3. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ `last_lt` —Å–Ω–æ–≤–∞ –±—Ä–∞–ª—Å—è –∏–∑ –ë–î, –≥–¥–µ –Ω–µ –±—ã–ª–æ –∑–∞–ø–∏—Å–∏ –æ–± —ç—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
4. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–Ω–æ–≤–∞ –ø–æ–ø–∞–¥–∞–ª–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É ‚Üí –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª

## –†–µ—à–µ–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `ton_scanner_states` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∫–∞–Ω–µ—Ä–∞ **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å: `TonScannerState`

**–§–∞–π–ª:** [src/database/models.py](src/database/models.py#L1409-L1461)

```python
class TonScannerState(Base):
    """
    TON Scanner state model - tracks last processed transaction for each address

    Prevents re-processing of already scanned transactions by storing
    the logical time (lt) of the last successfully scanned transaction
    """
    __tablename__ = "ton_scanner_states"

    address: str              # TON –∞–¥—Ä–µ—Å (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
    last_lt: int             # Logical time –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    last_tx_hash: str        # Hash –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
    created_at: datetime
    updated_at: datetime
```

#### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** [alembic/versions/f8a42c1b3e9d_add_ton_scanner_state_table.py](alembic/versions/f8a42c1b3e9d_add_ton_scanner_state_table.py)

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:**
```bash
source .venv/bin/activate
alembic upgrade head
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω `ton_monitor_service.py`

**–§–∞–π–ª:** [src/services/ton_monitor_service.py](src/services/ton_monitor_service.py)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–µ `scan_address`:**

- ‚ùå **–ë—ã–ª–æ:** –ü–æ–ª—É—á–µ–Ω–∏–µ `last_lt` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ Payment
- ‚úÖ **–°—Ç–∞–ª–æ:** –ü–æ–ª—É—á–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ `TonScannerState` –¥–ª—è –∞–¥—Ä–µ—Å–∞

- ‚ùå **–ë—ã–ª–æ:** `last_lt` –æ–±–Ω–æ–≤–ª—è–ª—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ —Ü–∏–∫–ª–µ
- ‚úÖ **–°—Ç–∞–ª–æ:** `last_lt` **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î** –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```python
# –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º state –¥–ª—è –∞–¥—Ä–µ—Å–∞
result = await session.execute(
    select(TonScannerState).where(TonScannerState.address == address)
)
scanner_state = result.scalar_one_or_none()

if scanner_state:
    last_lt = scanner_state.last_lt
else:
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π state
    scanner_state = TonScannerState(address=address, last_lt=0)
    session.add(scanner_state)
    await session.commit()

# ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ...

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π state –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
if scanner_state and last_lt > scanner_state.last_lt:
    scanner_state.last_lt = last_lt
    scanner_state.updated_at = datetime.now(UTC)
    await session.commit()
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚úÖ **–ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –Ω–µ–≤–µ—Ä–Ω—ã–º memo
‚úÖ **–õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ**, –±–µ–∑ —Å–ø–∞–º–∞ –æ–± –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –æ—Ç–¥–µ–ª—å–Ω–æ

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ TON scanner:
```bash
source .venv/bin/activate
python -m src.tasks.ton_scanner
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º memo –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**, –∑–∞—Ç–µ–º –±–æ–ª—å—à–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å–æ—Å—Ç–æ—è–Ω–∏—è:
```sql
SELECT * FROM ton_scanner_states;
```

–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å —Å –≤–∞—à–∏–º TON deposit –∞–¥—Ä–µ—Å–æ–º –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º `last_lt`.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```bash
source .venv/bin/activate
alembic downgrade -1
```

### –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–¥–ª—è –ø–µ—Ä–µ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –Ω–∞—á–∞–ª–∞)

```sql
DELETE FROM ton_scanner_states WHERE address = 'YOUR_TON_ADDRESS';
```

Scanner –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å `last_lt = 0`.

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞:** 2025-11-19
