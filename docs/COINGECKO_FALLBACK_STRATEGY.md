# CoinGecko API Fallback Strategy

## –ü—Ä–æ–±–ª–µ–º–∞

CoinGecko API –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ 503 (Service Unavailable) –∏–ª–∏ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞, —Ç.–∫. –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

## –†–µ—à–µ–Ω–∏–µ: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è Fallback Strategy

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

### 1Ô∏è‚É£ **–°–≤–µ–∂–∏–π –∫—ç—à (Redis + In-Memory)**
- TTL: 2-5 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –ü—Ä–∏ —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ API

### 2Ô∏è‚É£ **–£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—ç—à (Stale Cache)**
- TTL: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –ö–æ–≥–¥–∞ CoinGecko API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (503, 500, network errors)
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ, –Ω–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### 3Ô∏è‚É£ **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (Static Fallback)**
- TTL: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–∏–∑–∫–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –ö–æ–≥–¥–∞ –≤—Å–µ –∫—ç—à–∏ –ø—É—Å—Ç—ã/–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å —Ö–æ—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ Fallback –î–∞–Ω–Ω—ã–µ

```python
STATIC_FALLBACK_PRICES = {
    "bitcoin": {
        "usd": 43000,
        "usd_24h_change": 2.5,
        "usd_market_cap": 840000000000,
        "usd_24h_vol": 28000000000
    },
    "ethereum": {...},
    "toncoin": {...},
    # ... –µ—â–µ 7 –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–Ω–µ—Ç
}
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (_get_stale_cache)

```python
async def _get_stale_cache(cache_key, endpoint, params):
    # 1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å Redis (–¥–∞–∂–µ –µ—Å–ª–∏ expired)
    if redis_cache_exists:
        return redis_cache

    # 2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å in-memory cache (–¥–∞–∂–µ –µ—Å–ª–∏ expired)
    if in_memory_cache_exists:
        return in_memory_cache

    # 3. –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è /simple/price)
    if is_price_endpoint:
        return static_fallback_data

    # 4. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å–æ–≤—Å–µ–º
    return None
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (_make_request)

```python
# HTTP –æ—à–∏–±–∫–∏ (500, 503, etc.)
if response.status >= 500:
    stale_cache = await self._get_stale_cache(cache_key, endpoint, params)
    if stale_cache:
        return stale_cache  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ

# Network errors –ø–æ—Å–ª–µ –≤—Å–µ—Ö retry
except (ClientError, TimeoutError):
    stale_cache = await self._get_stale_cache(cache_key, endpoint, params)
    if stale_cache:
        return stale_cache

# –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
except Exception:
    stale_cache = await self._get_stale_cache(cache_key, endpoint, params)
    if stale_cache:
        return stale_cache
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–í—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –æ—Ç–∫–∞–∑–µ CoinGecko API

‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ –æ —Ç–æ–º, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
```
‚ö†Ô∏è Using STALE Redis cache as fallback: syntra:coingecko:price:...
‚ö†Ô∏è Using STATIC FALLBACK data for 5 coins. This is APPROXIMATE data!
```

‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Impact**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏

‚úÖ **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –º–æ–Ω–µ—Ç –≤ STATIC_FALLBACK_PRICES

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```
[DEBUG] Redis cache HIT: syntra:coingecko:price:bitcoin (type: price, TTL: 120s)
```

### Stale Cache
```
[WARNING] Using STALE Redis cache as fallback: syntra:coingecko:price:bitcoin
[WARNING] Using STALE fallback cache (age: 2.5h): syntra:coingecko:price:ethereum
```

### Static Fallback
```
[WARNING] ‚ö†Ô∏è Using STATIC FALLBACK data for 5 coins. This is APPROXIMATE data - actual prices may differ!
```

### –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑
```
[ERROR] No stale cache or static fallback available for syntra:coingecko:markets:...
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ö†Ô∏è **Static Fallback —Ç–æ–ª—å–∫–æ –¥–ª—è /simple/price**: –î—Ä—É–≥–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (markets, trending, etc.) –Ω–µ –∏–º–µ—é—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

‚ö†Ô∏è **–î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º–∏**: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π fallback —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö

‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –º–æ–Ω–µ—Ç**: –¢–æ–ª—å–∫–æ 10 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º fallback

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è fallback:

1. **Grep –ª–æ–≥–∏ –Ω–∞ WARNING**: `grep "STALE" logs/app.log`
2. **Grep –ª–æ–≥–∏ –Ω–∞ STATIC**: `grep "STATIC FALLBACK" logs/app.log`
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É 503 –æ—à–∏–±–æ–∫**: `grep "503" logs/app.log | wc -l`

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

üîÆ **UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã**: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–∑—Ä–∞—Å—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ stale cache

üîÆ **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Static Fallback**: –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –º–æ–Ω–µ—Ç –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

üîÆ **Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –£–≤–µ–¥–æ–º–ª—è—Ç—å –∞–¥–º–∏–Ω–æ–≤ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ fallback –¥–∞–Ω–Ω—ã—Ö

üîÆ **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ API (Binance, CoinMarketCap) –∫–∞–∫ fallback

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –≠–º—É–ª—è—Ü–∏—è CoinGecko downtime
```python
# –í pytest –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
async def test_fallback():
    # Mock CoinGecko to return 503
    with patch('aiohttp.ClientSession.get') as mock_get:
        mock_get.return_value.status = 503

        # –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å stale cache –∏–ª–∏ static fallback
        result = await coingecko_service.get_price('bitcoin')
        assert result is not None
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
tail -f logs/app.log | grep -E "(STALE|STATIC FALLBACK|503)"
```

## –í—ã–≤–æ–¥—ã

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **99.9% uptime** –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞—Ö, –¥–∞–∂–µ –∫–æ–≥–¥–∞ CoinGecko API –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è user experience –∏ –¥–æ–≤–µ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.
