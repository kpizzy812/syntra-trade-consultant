# –°–µ—Å—Å–∏—è 2025-01-25: Tier-aware –ø–∞–º—è—Ç—å + –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∞—Ç—ã

## –í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ

### 1. Tier-aware —Å–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏

#### Backend –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- **[config/limits.py](../config/limits.py)** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–º—è—Ç–∏
  ```python
  "chat_history_messages": 0,  # FREE: –±–µ–∑ –ø–∞–º—è—Ç–∏
  "chat_history_messages": 5,  # BASIC: 5 —Å–æ–æ–±—â–µ–Ω–∏–π
  "chat_history_messages": 10, # PREMIUM: 10 —Å–æ–æ–±—â–µ–Ω–∏–π
  "chat_history_messages": 50, # VIP: 50 —Å–æ–æ–±—â–µ–Ω–∏–π
  "save_chat_history": False,  # FREE: –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
  "save_chat_history": True,   # BASIC+: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
  ```

- **[config/prompts.py](../config/prompts.py)** - –æ–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
  - –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "–ö–û–ù–¢–ï–ö–°–¢ –ò –ü–ê–ú–Ø–¢–¨"
  - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞

- **[config/prompts_free.py](../config/prompts_free.py)** - –æ–±–Ω–æ–≤–ª–µ–Ω FREE –ø—Ä–æ–º–ø—Ç
  - –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–º—è—Ç–∏
  - –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º

#### Mini App (openai_service.py):
- **[src/services/openai_service.py](../src/services/openai_service.py)**
  - `get_context_messages()` - tier-aware –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
  - `stream_completion()` - tier-aware —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  - FREE: –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é
  - BASIC+: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ –ª–∏–º–∏—Ç–∞–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç

- **[src/api/chat.py](../src/api/chat.py)**
  - –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–µ—Ä–µ–¥–∞—é—Ç `user_tier`
  - `/chat/stream`, `/chat/message`, `/chat/regenerate`

#### Telegram Bot (two_step_service.py):
- **[src/services/openai_service_two_step.py](../src/services/openai_service_two_step.py)**
  - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `user_tier`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `get_chat_history_limit(tier)`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `should_save_chat_history(tier)`
  - FREE: –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç
  - BASIC+: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ –ª–∏–º–∏—Ç–∞–º

- **[src/bot/handlers/chat.py](../src/bot/handlers/chat.py)**
  - –ü–æ–ª—É—á–∞–µ—Ç tier –∏–∑ `db_user.subscription.tier`
  - –ü–µ—Ä–µ–¥–∞–µ—Ç `user_tier` –≤ two_step_service

### 2. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∞—Ç—ã (–∫–∞–∫ –≤ ChatGPT)

#### –ú–æ–¥–µ–ª–∏ –ë–î:
- **[src/database/models.py](../src/database/models.py)**
  ```python
  class Chat:
      id, user_id, title, created_at, updated_at
      messages = relationship("ChatMessage")

  class ChatMessage:
      id, chat_id, role, content, timestamp, tokens_used, model
      chat = relationship("Chat")

  # ChatHistory - –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  ```

#### –ú–∏–≥—Ä–∞—Ü–∏—è:
- **[alembic/versions/7c0d3cfea4ac_add_multiple_chats_support.py](../alembic/versions/7c0d3cfea4ac_add_multiple_chats_support.py)**
  - –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `chats` –∏ `chat_messages`
  - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  - CASCADE —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞

#### CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏:
- **[src/database/crud.py](../src/database/crud.py)** - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏:
  - `create_chat()` - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç
  - `get_user_chats()` - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `get_chat_by_id()` - –ø–æ–ª—É—á–∏—Ç—å —á–∞—Ç (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞)
  - `update_chat_title()` - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —á–∞—Ç
  - `delete_chat()` - —É–¥–∞–ª–∏—Ç—å —á–∞—Ç (+ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
  - `add_chat_message_to_chat()` - –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
  - `get_chat_messages()` - –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
  - `get_or_create_default_chat()` - –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ üöß

### 3. API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞–º–∏ (TODO)
- `GET /api/chats` - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
- `POST /api/chats` - —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç
- `GET /api/chats/{chat_id}/messages` - —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
- `PUT /api/chats/{chat_id}/title` - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
- `DELETE /api/chats/{chat_id}` - —É–¥–∞–ª–∏—Ç—å

### 4. –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (TODO)
- `/chat/stream` - –ø—Ä–∏–Ω–∏–º–∞—Ç—å `chat_id` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `/chat/message` - –ø—Ä–∏–Ω–∏–º–∞—Ç—å `chat_id` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ï—Å–ª–∏ `chat_id` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç

### 5. –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π (TODO)
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT-4o-mini –¥–ª—è –∫—Ä–∞—Ç–∫–æ–≥–æ —Å–∞–º–º–∞—Ä–∏

### 6. Frontend Sidebar (TODO)
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (—Å–∫—Ä—ã–≤–∞–µ–º—ã–π)
- –ö–Ω–æ–ø–∫–∞ "New Chat"
- –í—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤
- –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
User
  ‚îú‚îÄ‚îÄ chats[]
  ‚îÇ    ‚îú‚îÄ‚îÄ Chat 1: "Bitcoin –∞–Ω–∞–ª–∏–∑"
  ‚îÇ    ‚îÇ    ‚îú‚îÄ‚îÄ Message 1: user: "–ß—Ç–æ —Å BTC?"
  ‚îÇ    ‚îÇ    ‚îú‚îÄ‚îÄ Message 2: assistant: "BTC –Ω–∞ $50k..."
  ‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ Message 3: user: "–ê —á—Ç–æ —Å ETH?"
  ‚îÇ    ‚îÇ
  ‚îÇ    ‚îú‚îÄ‚îÄ Chat 2: "–ê–ª—å—Ç–∫–æ–∏–Ω—ã"
  ‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ messages[]
  ‚îÇ    ‚îÇ
  ‚îÇ    ‚îî‚îÄ‚îÄ Chat 3: "New Chat" (active)
  ‚îÇ         ‚îî‚îÄ‚îÄ [empty]
  ‚îÇ
  ‚îî‚îÄ‚îÄ chat_history[] (deprecated, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
```

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
```
1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç (–∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π)
2. –ü–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
3. –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç ‚Üí –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
4. –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ = –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∑–∞–ø—Ä–æ—Å
5. –ß–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω–æ –ø—É—Å—Ç—ã–µ (–±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π)
```

### BASIC+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
```
1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç
2. –ü–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ chat_messages
3. AI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5/10/50 —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∞—Ä–∏—Ñ–∞)
4. –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ chat_messages
5. –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —á–∞—Ç—ã
6. –ú–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
```

## –õ–∏–º–∏—Ç—ã –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º

| –¢–∞—Ä–∏—Ñ | –ü–∞–º—è—Ç—å | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ | –ß–∞—Ç—ã |
|-------|--------|------------|------|
| FREE | 0 —Å–æ–æ–±—â–µ–Ω–∏–π | ‚ùå –ù–µ—Ç | ‚úÖ –°–æ–∑–¥–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–µ |
| BASIC | 5 —Å–æ–æ–±—â–µ–Ω–∏–π | ‚úÖ –î–∞ | ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ |
| PREMIUM | 10 —Å–æ–æ–±—â–µ–Ω–∏–π | ‚úÖ –î–∞ | ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ |
| VIP | 50 —Å–æ–æ–±—â–µ–Ω–∏–π | ‚úÖ –î–∞ | ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ |

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
- FREE: –º–∏–Ω–∏–º—É–º —Ñ—É–Ω–∫—Ü–∏–π ‚Üí —Å—Ç–∏–º—É–ª –∫ –∞–ø–≥—Ä–µ–π–¥—É
- BASIC+: –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ø–∞–º—è—Ç—å—é

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç
- FREE: 0 tokens –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é
- –ü–ª–∞—Ç–Ω—ã–µ: —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—Ä–∏–∏

### 3. UX –∫–∞–∫ –≤ ChatGPT
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∞—Ç—ã
- –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- Sidebar —Å –∏—Å—Ç–æ—Ä–∏–µ–π

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–æ–∑–¥–∞—Ç—å API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã** –¥–ª—è —á–∞—Ç–æ–≤
2. **–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `chat_id`
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é** –Ω–∞–∑–≤–∞–Ω–∏–π —á–∞—Ç–æ–≤
4. **–°–æ–∑–¥–∞—Ç—å Sidebar** –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
5. **–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
6. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

### Backend (‚úÖ –ì–æ—Ç–æ–≤–æ):
- config/limits.py
- config/prompts.py
- config/prompts_free.py
- src/services/openai_service.py
- src/services/openai_service_two_step.py
- src/api/chat.py
- src/bot/handlers/chat.py
- src/database/models.py
- src/database/crud.py
- alembic/versions/7c0d3cfea4ac_add_multiple_chats_support.py

### Frontend (üöß TODO):
- frontend/components/Sidebar.tsx (new)
- frontend/components/ChatList.tsx (new)
- frontend/app/chat/page.tsx (update)
- frontend/shared/api/client.ts (update)

### API (üöß TODO):
- src/api/chats.py (new router)
- src/api/router.py (update)

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [TIER_MEMORY_SYSTEM.md](./TIER_MEMORY_SYSTEM.md) - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏
- –≠—Ç–æ—Ç —Ñ–∞–π–ª - —Å–≤–æ–¥–∫–∞ —Å–µ—Å—Å–∏–∏

---

**–î–∞—Ç–∞:** 2025-01-25
**–°—Ç–∞—Ç—É—Å:** Backend –≥–æ—Ç–æ–≤, Frontend –≤ –ø–ª–∞–Ω–∞—Ö
