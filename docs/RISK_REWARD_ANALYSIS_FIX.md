# Исправление анализа риск/ревард

## Проблема

При вопросе "В момент времени где больше риск ревард в крипте?" AI неправильно отвечал что максимальный риск/ревард у Bitcoin, хотя правильный ответ — у альткоинов.

### Корневые причины:

1. **Отсутствие данных по альткоинам** в `get_market_overview()`
   - Возвращались только BTC и ETH
   - Не было данных про % от ATH для альтов

2. **Step 1 возвращал текст вместо JSON**
   - Вопрос не распознавался как market overview
   - Step 1 делал финальные выводы вместо сбора данных

3. **Отсутствие правил сегментации** по риск/ревард
   - Нет разделения на BTC/ETH/Altcoins по RR
   - Нет формулы расчёта потенциала роста

## Решение

### 1. Расширены данные в `get_market_overview()` (crypto_tools.py)

**Добавлено:**
- Топ-10 альткоинов: SOL, BNB, ADA, AVAX, DOT, LINK, MATIC, ARB, OP, SUI
- Для каждого альта: `id`, `symbol`, `price`, `change_24h`, `ath`, `ath_change_pct`
- Расчёт среднего и медианного drawdown по альтам
- Данные по ATH для BTC и ETH (`ath`, `ath_change_pct`)

**Формат возврата:**
```json
{
  "success": true,
  "btc": {
    "price": 92878,
    "change_24h": 0.84,
    "ath": 126080,
    "ath_change_pct": -26.29,
    "rsi": 30.93,
    "support": 77943,
    "resistance": 99113,
    "funding_rate": 0.0037,
    "long_short_ratio": 3.13,
    "market_phase": "accumulate"
  },
  "eth": {
    "price": 3119.98,
    "change_24h": 3.1,
    "ath": 4878,
    "ath_change_pct": -36.0
  },
  "alts": [
    {
      "id": "solana",
      "symbol": "SOL",
      "price": 141.50,
      "change_24h": 2.3,
      "ath": 289.20,
      "ath_change_pct": -51.1
    },
    // ... другие альты
  ],
  "market": {
    "btc_dominance": 56.75,
    "eth_dominance": 11.53,
    "altcoin_dominance": 31.72,
    "fear_greed_index": 11,
    "trend": "sideways"
  },
  "news": [...]
}
```

### 2. Обновлён ANALYSIS_SYSTEM_PROMPT (openai_service_two_step.py)

**Изменения:**
- Расширена категория вопросов для `get_market_overview()`:
  - Добавлены вопросы о риск/ревард: "где больше риск ревард", "what's the best risk/reward"
- Документированы все поля возвращаемых данных (BTC, ETH, alts с ATH)
- Добавлено правило: "IMPORTANT FOR RISK/REWARD QUESTIONS" с инструкциями по сегментации

### 3. Добавлен раздел РИСК/РЕВАРД АНАЛИЗ в промпты

**В config/prompts.py и config/prompts_en.py:**

Добавлен новый раздел с правилами:

**Сегментация по риск/ревард:**
1. **BTC**: Минимальный риск / Минимальный RR
   - Близок к хаям → малый потенциал роста
   - Самый ликвидный → меньше волатильности

2. **ETH + топовые L1**: Средний риск / Средний RR
   - Дальше от хаев чем BTC → больше потенциал

3. **Альткоины (major)**: Высокий риск / Высокий RR
   - Просадка -50..-70% от ATH → большой потенциал
   - Средняя ликвидность → высокая волатильность

4. **Shitcoins**: Максимальный риск / Максимальный RR
   - Просадка -80..-95% от ATH → огромный потенциал

**Формула RR:**
```
RR = (Потенциал роста до ATH) / (Риск просадки + риск ликвидности)
```

**Формат ответа:**
- Разложить по сегментам с конкретными данными
- Указать % от ATH для каждого сегмента
- Дать чёткий вывод: где максимальный RR и почему

### Пример правильного ответа:

```
BTC на $92,800 (-26% от ATH $126k) — защитный актив, но потенциал роста
ограничен до ATH всего +36%. RSI 31, funding бычий, но это не меняет
фундаментальный RR.

ETH $3,120 (-36% от ATH $4,878) — чуть лучше RR, потенциал до ATH +56%.
Но пока даже не перебил прошлый цикл.

Альты — вот где настоящий RR:
• SOL -51% от ATH → потенциал x2
• ARB -90% от ATH → потенциал x10
• Медианная просадка топ-альтов: -65%

Максимальный риск/ревард сейчас в альтах. Они в яме, BTC близок к хаям.
Но помни: высокий RR = высокий риск слить всё.

Твой выбор: безопасный +36% с BTC или рискованный x2-x10 с альтами.

⚡ NFA
```

## Результат

Теперь AI:
1. ✅ Собирает данные по альткоинам автоматически
2. ✅ Правильно распознаёт вопросы о риск/ревард
3. ✅ Возвращает JSON из Step 1 для market overview/risk-reward вопросов
4. ✅ Применяет сегментацию BTC/ETH/Alts по RR
5. ✅ Даёт правильный ответ: максимальный RR в альтах

## Технические детали

**Файлы изменены:**
- `src/services/crypto_tools.py`: get_market_overview() - добавлены альты и ATH данные
- `src/services/openai_service_two_step.py`: ANALYSIS_SYSTEM_PROMPT - обновлены правила
- `config/prompts.py`: SYNTRA_CORE_PROMPT - добавлен раздел РИСК/РЕВАРД АНАЛИЗ
- `config/prompts_en.py`: SYNTRA_CORE_PROMPT - добавлен раздел RISK/REWARD ANALYSIS

**Производительность:**
- Сбор данных по 10 альткоинам добавит ~2-3 секунды к get_market_overview()
- Использует кэширование CoinGecko (TTL 90s для цен, 300s для extended data)
- Общее время выполнения: ~5-6 секунд для полного market overview

**API rate limits:**
- CoinGecko Free: 10-30 requests/min
- Текущий расход: 12 requests для get_market_overview() (BTC + ETH + 10 alts)
- Кэширование снижает реальное потребление до 1-2 requests/min
