# –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ - Revenue Share

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü—Ä–æ–±–ª–µ–º–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
- ‚ùå –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Ä–µ–≤—à–∞—Ä–∞ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ –ë–î
- ‚ùå –ù–µ–ª—å–∑—è –±—ã—Å—Ç—Ä–æ –º–µ–Ω—è—Ç—å –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π
- ‚ùå –ù–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### ‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ `config/referral_config.py`
- ‚úÖ –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
config/
  ‚îî‚îÄ‚îÄ referral_config.py        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∏—Ä–æ–≤ –∏ —Ä–µ–≤—à–∞—Ä–∞

src/
  ‚îú‚îÄ‚îÄ services/
  ‚îÇ   ‚îî‚îÄ‚îÄ telegram_stars_service.py   # –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ–≤—à–∞—Ä–∞
  ‚îî‚îÄ‚îÄ database/
      ‚îî‚îÄ‚îÄ crud.py                      # add_revenue_share()
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∏—Ä–æ–≤

–§–∞–π–ª: `config/referral_config.py`

```python
REFERRAL_TIERS = {
    "bronze": {
        "min_referrals": 0,
        "max_referrals": 4,
        "revenue_share_percent": 0.0,   # ‚Üê –ú–µ–Ω—è–π –∑–¥–µ—Å—å!
    },
    "silver": {
        "min_referrals": 5,
        "max_referrals": 14,
        "revenue_share_percent": 5.0,
    },
    "gold": {
        "min_referrals": 15,
        "max_referrals": 49,
        "revenue_share_percent": 10.0,
    },
    "platinum": {
        "min_referrals": 50,
        "max_referrals": None,
        "revenue_share_percent": 15.0,
    },
}
```

### –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã:

1. –û—Ç–∫—Ä–æ–π `config/referral_config.py`
2. –ò–∑–º–µ–Ω–∏ `revenue_share_percent`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
4. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –ù–ï –ù–£–ñ–ù–ê!** ‚úÖ

---

## üßÆ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç

–§—É–Ω–∫—Ü–∏—è `calculate_optimal_revenue_share()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ:

- **–°—Ä–µ–¥–Ω–∏–π usage** (40% –æ—Ç –ª–∏–º–∏—Ç–∞)
- **–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞** ($0.00648)
- **–¶–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏** ($4.99 - $49.99)
- **–¶–µ–ª–µ–≤–∞—è –º–∞—Ä–∂–∞** (50%)

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞:

```bash
python3 config/referral_config.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
BASIC ($4.99/mo):   9.42% ‚Üí $0.47
PREMIUM ($24.99/mo): 9.44% ‚Üí $2.36
VIP ($49.99/mo):     9.44% ‚Üí $4.72
```

---

## üí∞ –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∞–∫—Ç—É–∞–ª—å–Ω–æ)

| Tier | –†–µ—Ñ–µ—Ä–∞–ª–æ–≤ | –†–µ–≤—à–∞—Ä | –ú–µ—Å—è—á–Ω—ã–π –±–æ–Ω—É—Å | –°–∫–∏–¥–∫–∞ |
|------|-----------|--------|----------------|--------|
| ü•â Bronze | 0-4 | **0%** | 0 req | 0% |
| ü•à Silver | 5-14 | **5%** | 50 req | 10% |
| ü•á Gold | 15-49 | **10%** | 150 req | 20% |
| üíé Platinum | 50+ | **15%** | 500 req | 30% |

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
```
User A (—Ä–µ—Ñ–µ—Ä–∞–ª) ‚Üí –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç PREMIUM $24.99
```

### 2. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è
```python
referrer = await get_referrer(session, user_a.id)
# –ù–∞—Ö–æ–¥–∏—Ç User B (—Ä–µ—Ñ–µ—Ä–µ—Ä)
```

### 3. –ü–æ–ª—É—á–∞–µ—Ç tier —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
```python
referrer_tier = await get_referral_tier(session, referrer.id)
# Tier: "gold"
```

### 4. –ß–∏—Ç–∞–µ—Ç % –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
```python
tier_config = get_tier_config("gold")
revenue_share_percent = tier_config["revenue_share_percent"]  # 10%
```

### 5. –ù–∞—á–∏—Å–ª—è–µ—Ç —Ä–µ–≤—à–∞—Ä
```python
revenue_share_amount = 24.99 * 0.10 = $2.50
await add_revenue_share(
    referrer_id=user_b.id,
    amount=2.50
)
```

### 6. –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
```python
User B:
  referral_balance += $2.50
  total_referral_earnings += $2.50
```

---

## üìä –ú–∞—Ä–∂–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –° —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏:
- **Usage:** 40% –æ—Ç –ª–∏–º–∏—Ç–∞
- **–°—Ä–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å:** $0.00648
- **Prompt caching:** —ç–∫–æ–Ω–æ–º–∏—è ~20%

### –ú–∞—Ä–∂–∞ –ø–æ—Å–ª–µ —Ä–µ–≤—à–∞—Ä–∞:

**PREMIUM ($24.99/–º–µ—Å):**
- –†–∞—Å—Ö–æ–¥—ã: $7.78
- –ú–∞—Ä–∂–∞ –¥–æ —Ä–µ–≤—à–∞—Ä–∞: $17.21 (69%)
- –†–µ–≤—à–∞—Ä 10%: $2.50
- **–ò—Ç–æ–≥–æ: $14.71** (59% –º–∞—Ä–∂–∞) ‚úÖ

**VIP ($49.99/–º–µ—Å):**
- –†–∞—Å—Ö–æ–¥—ã: $15.56
- –ú–∞—Ä–∂–∞ –¥–æ —Ä–µ–≤—à–∞—Ä–∞: $34.43 (69%)
- –†–µ–≤—à–∞—Ä 15%: $7.50
- **–ò—Ç–æ–≥–æ: $26.93** (54% –º–∞—Ä–∂–∞) ‚úÖ

---

## üìà Real-time Margin Tracking

### –ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤

–†–∞–Ω—å—à–µ –º—ã —Å—á–∏—Ç–∞–ª–∏ –º–∞—Ä–∂—É —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏:
```python
# ‚ùå –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç (–Ω–µ—Ç–æ—á–Ω—ã–π)
avg_cost_per_request = 0.00648  # –°—Ä–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ
usage_percent = 0.40             # –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ
monthly_cost = limit * 30 * usage_percent * avg_cost_per_request
margin = subscription_price - monthly_cost
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ –†–ï–ê–õ–¨–ù–û–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API
- ‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –†–ï–ê–õ–¨–ù–ê–Ø —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ùå –ù–µ–ª—å–∑—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≤—à–∞—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–æ–≤

### ‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥: Real-time Analytics

–¢–µ–ø–µ—Ä—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º **–†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ** –∏–∑ –ë–î:

```python
# ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ—á–Ω—ã–µ)
from src.services.margin_calculator import get_real_costs_per_user

costs = await get_real_costs_per_user(session, user_id, days=30)
# {
#   'total_cost': 8.50,           # –†–µ–∞–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã
#   'request_count': 850,         # –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
#   'avg_cost_per_request': 0.01, # –†–µ–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
# }
```

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

1. **ChatMessage —Ç–∞–±–ª–∏—Ü–∞** - —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã:
   - `total_tokens` - —Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
   - `total_cost` - —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏–ª –∑–∞–ø—Ä–æ—Å (USD)
   - `created_at` - –∫–æ–≥–¥–∞ –±—ã–ª –∑–∞–ø—Ä–æ—Å

2. **Payment —Ç–∞–±–ª–∏—Ü–∞** - —Ä–µ–∞–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞:
   - `amount` - —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–ª–∞—Ç–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
   - `status` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ª–∏ –ø–ª–∞—Ç–µ–∂
   - `completed_at` - –∫–æ–≥–¥–∞ –æ–ø–ª–∞—Ç–∏–ª

3. **User —Ç–∞–±–ª–∏—Ü–∞** - —Ä–µ–≤—à–∞—Ä –º–µ—Ç—Ä–∏–∫–∏:
   - `total_referral_earnings` - —Å–∫–æ–ª—å–∫–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ —Ä–µ—Ñ–µ—Ä–µ—Ä—É

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

#### 1. –ö–æ–º–∞–Ω–¥–∞ `/admin_margin`

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –º–∞—Ä–∂–∏:
```
üí∞ Real-time Margin Analytics
–ü–µ—Ä–∏–æ–¥: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π

üìä –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
‚îú –í—ã—Ä—É—á–∫–∞: $1,249.50
‚îú –†–∞—Å—Ö–æ–¥—ã: $425.30
‚îú –ú–∞—Ä–∂–∞: $824.20 (65.9%)
‚îú –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞/—é–∑–µ—Ä: $16.48
‚îî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 50 (45 –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö)

ü§ù Revenue Share:
‚îú –í—ã–ø–ª–∞—á–µ–Ω–æ: $124.95
‚îú –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π %: 10.0%
‚îî –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π %: 7.95%
   (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

üéØ –ú–∞—Ä–∂–∞ –ø–æ —Ç–∏—Ä–∞–º:
üü¢ BASIC (20 users):
   Revenue: $99.80 | Costs: $30.50
   Margin: $69.30 (69.4%)

üü° PREMIUM (25 users):
   Revenue: $624.75 | Costs: $187.43
   Margin: $437.32 (70.0%)

üî¥ VIP (5 users):
   Revenue: $249.95 | Costs: $75.20
   Margin: $174.75 (69.9%)

‚ö†Ô∏è –ê–ª–µ—Ä—Ç—ã (–º–∞—Ä–∂–∞ <30%):
–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 2

‚îú @problem_user (ID: 123456789)
‚îÇ  –ú–∞—Ä–∂–∞: 25.5% ($6.38)
‚îÇ  Revenue: $24.99 | Cost: $18.61
```

#### 2. –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –¥–æ—Å—Ç—É–ø

```python
from src.services.margin_calculator import (
    get_global_margin_analytics,
    get_margin_by_tier,
    check_margin_alerts,
)

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
analytics = await get_global_margin_analytics(session, days=30)
recommended_revshare = analytics['recommended_revenue_share']

# –ü–æ —Ç–∏—Ä–∞–º
tier_data = await get_margin_by_tier(session, days=30)
premium_margin = tier_data['premium']['margin_percent']

# –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
alerts = await check_margin_alerts(session, threshold_percent=30.0)
if alerts['alert_count'] > 0:
    print(f"‚ö†Ô∏è {alerts['alert_count']} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–∏–∑–∫–æ–π –º–∞—Ä–∂–æ–π!")
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–≤—à–∞—Ä–∞

–ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç:

```python
# –ò–∑ get_global_margin_analytics()
actual_margin = 65.9%           # –†–µ–∞–ª—å–Ω–∞—è –º–∞—Ä–∂–∞
target_margin = 50.0%           # –¶–µ–ª–µ–≤–∞—è –º–∞—Ä–∂–∞
available_margin = 65.9 - 50 = 15.9%

# –†–µ–≤—à–∞—Ä = 50% –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–∞—Ä–∂–∏ (–æ—Å—Ç–∞–ª—å–Ω–æ–µ - —Ä–µ–∑–µ—Ä–≤)
recommended_revshare = 15.9 * 0.5 = 7.95%
```

–ï—Å–ª–∏ –º–∞—Ä–∂–∞ –≤—ã—Å–æ–∫–∞—è - –º–æ–∂–Ω–æ –ø–æ–≤—ã—Å–∏—Ç—å —Ä–µ–≤—à–∞—Ä.
–ï—Å–ª–∏ –º–∞—Ä–∂–∞ –Ω–∏–∑–∫–∞—è - –Ω—É–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å —Ä–µ–≤—à–∞—Ä –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã.

### –ê–ª–µ—Ä—Ç—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```python
alerts = await check_margin_alerts(session, threshold_percent=30.0)

for user in alerts['low_margin_users']:
    if user['margin_percent'] < 20:
        # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–∞—è –º–∞—Ä–∂–∞ - –Ω—É–∂–Ω–æ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å!
        logger.warning(f"User {user['telegram_id']} has {user['margin_percent']}% margin!")
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å upgrade –ø–æ–¥–ø–∏—Å–∫–∏
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—á–µ–º—É —Ç–∞–∫ –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã (–¥–æ–±–∞–≤–∏—Ç—å caching)

---

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä—ã
```python
# –ë–æ–Ω—É—Å—ã –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
QUALITY_MULTIPLIERS = {
    "high_retention": 1.2,    # +20% –µ—Å–ª–∏ retention > 80%
    "high_ltv": 1.15,         # +15% –µ—Å–ª–∏ LTV > —Å—Ä–µ–¥–Ω–∏–π
    "fast_conversion": 1.1,   # +10% –µ—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—è < 7 –¥–Ω–µ–π
}
```

### 2. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–∞–∑–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –†–∞–∑–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Ä–µ–≤—à–∞—Ä–∞
- –ê–Ω–∞–ª–∏–∑ conversion –∏ LTV

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∞—Ä–∂–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ low margin

### 4. –ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã

‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û:**
```
/admin_margin  # Real-time margin analytics –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ë–î
```

üìä –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `/admin_margin`:
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏** (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π):
  - –í—ã—Ä—É—á–∫–∞, —Ä–∞—Å—Ö–æ–¥—ã, –º–∞—Ä–∂–∞ (USD –∏ %)
  - –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö/—É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

- **Revenue Share –º–µ—Ç—Ä–∏–∫–∏**:
  - –°–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤
  - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π % —Ä–µ–≤—à–∞—Ä–∞ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π)
  - –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π % –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö

- **–ú–∞—Ä–∂–∞ –ø–æ —Ç–∏—Ä–∞–º**:
  - BASIC, PREMIUM, VIP
  - Revenue vs Costs –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
  - –ú–∞—Ä–∂–∞ –≤ USD –∏ %

- **–ê–ª–µ—Ä—Ç—ã**:
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –º–∞—Ä–∂–æ–π <30%
  - Top 5 –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —é–∑–µ—Ä–æ–≤
  - –î–µ—Ç–∞–ª–∏: revenue, cost, margin

üéØ **–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è:**
```
/admin_revshare_set gold 12.5  # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 12.5% –¥–ª—è Gold
/admin_revshare_stats          # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–≤—à–∞—Ä—É
/admin_revshare_optimize       # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π %
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ì–∏–±–∫–æ—Å—Ç—å** - –º–µ–Ω—è–π –ø—Ä–æ—Ü–µ–Ω—Ç—ã –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π
2. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –≤–µ—Å—å —Ä–∞—Å—á–µ—Ç –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∫–æ–Ω—Ç—Ä–æ–ª—å –º–∞—Ä–∂–∏
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏—Ä—ã
5. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –≥–æ—Ç–æ–≤–æ –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üìù –õ–æ–≥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π

–ö–∞–∂–¥–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:

```
INFO: Revenue share credited:
  referrer=123, referee=456,
  amount=$2.50, percent=10% (config)
```

–ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ö–æ–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–æ
- –û—Ç –∫–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°—É–º–º–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç
- –ò—Å—Ç–æ—á–Ω–∏–∫ (config/manual)

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç—ã:
- ‚úÖ MAX_REVENUE_SHARE_PERCENT = 20% (–ø–æ—Ç–æ–ª–æ–∫)
- ‚úÖ TARGET_MARGIN_PERCENT = 50% (—Ü–µ–ª–µ–≤–∞—è –º–∞—Ä–∂–∞)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞

### –ê–ª–µ—Ä—Ç—ã:
```python
ALERT_THRESHOLDS = {
    "low_margin": 30.0,      # –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ < 30%
    "high_churn": 20.0,      # –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ > 20%
    "low_conversion": 5.0,   # –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ < 5%
}
```

---

## üìñ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç Gold tier:

1. –û—Ç–∫—Ä–æ–π `config/referral_config.py`
2. –ù–∞–π–¥–∏ —Å–µ–∫—Ü–∏—é "gold"
3. –ò–∑–º–µ–Ω–∏:
   ```python
   "revenue_share_percent": 12.0,  # –ë—ã–ª–æ 10.0
   ```
4. –°–æ—Ö—Ä–∞–Ω–∏
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
6. –ì–æ—Ç–æ–≤–æ! –ù–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç 12%

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π tier:

```python
"diamond": {
    "min_referrals": 100,
    "max_referrals": None,
    "revenue_share_percent": 20.0,
    "monthly_bonus": 1000,
    "discount_percent": 40.0,
    "display_emoji": "üíéüíé",
}
```

---

## üéì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç "–ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º"

```
1. –ü–ª–∞—Ç–µ–∂ ‚Üí  telegram_stars_service.py
              ‚Üì
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Üí get_referrer(user_id)
              ‚Üì
3. Tier ‚Üí     get_referral_tier(referrer_id)
              ‚Üì
4. Config ‚Üí   get_tier_config(tier_name)
              ‚Üì
5. –†–∞—Å—á–µ—Ç ‚Üí   amount * (percent / 100)
              ‚Üì
6. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ ‚Üí add_revenue_share()
              ‚Üì
7. –õ–æ–≥ ‚Üí      logger.info(...)
```

---

–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞:
- ‚úÖ –ì–∏–±–∫–∞—è
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è
- ‚úÖ –õ–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è
