# ะะตัะตัะฐะปัะฝะฐั ะกะธััะตะผะฐ - ะะฒัะพะผะฐัะธัะตัะบะฐั ะะบัะธะฒะฐัะธั

## ะะฑะทะพั

ะะตัะตัะฐะปัะฝะฐั ัะธััะตะผะฐ ั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะฐะบัะธะฒะฐัะธะตะน ะธ ะฝะฐัะธัะปะตะฝะธะตะผ ะฑะพะฝััะพะฒ.

## ะะพะณะธะบะฐ ะะฐะฑะพัั

### 1. ะะตะณะธัััะฐัะธั ะงะตัะตะท ะะตัะตัะฐะปัะฝัั ะกััะปะบั

**ะะพะณะดะฐ ะฝะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะตัะตัะพะดะธั ะฟะพ ัะตัะตัะฐะปัะฝะพะน ัััะปะบะต:**

1. ะกะพะทะดะฐะตััั ะทะฐะฟะธัั `Referral` ัะพ ััะฐัััะพะผ `PENDING`
2. **ะะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั (referee) ะฟะพะปััะฐะตั ะกะะะะฃ:**
   - โ +5 ะฑะพะฝััะฝัั ะทะฐะฟัะพัะพะฒ
   - ะะพะฝััั ะฝะฐัะธัะปััััั ะฝะตะผะตะดะปะตะฝะฝะพ ัะตัะตะท ััะฝะบัะธั `grant_referee_bonus()`

3. ะัะธะณะปะฐัะธัะตะปั (referrer) ะฟะพะปััะฐะตั:
   - ๐ฉ ะฃะฒะตะดะพะผะปะตะฝะธะต ะพ ะฝะพะฒะพะผ ัะตัะตัะฐะปะต
   - โณ ะะพะฝััั ะะ ะฝะฐัะธัะปััััั (ะฟะพะบะฐ ัะตัะตัะฐะป ะฝะต ะฐะบัะธะฒะธััะตััั)

### 2. ะฃัะปะพะฒะธั ะะบัะธะฒะฐัะธะธ ะะตัะตัะฐะปะฐ

ะะตัะตัะฐะป ะฟะตัะตัะพะดะธั ะธะท ััะฐัััะฐ `PENDING` ะฒ `ACTIVE` ะบะพะณะดะฐ ะฒัะฟะพะปะฝะตะฝั **ะฒัะต** ััะปะพะฒะธั:

- โ ะะฐัะตะณะธัััะธัะพะฒะฐะฝ > 24 ัะฐัะพะฒ
- โ ะกะดะตะปะฐะป >= 5 ะทะฐะฟัะพัะพะฒ (ะทะฐ ะฟะพัะปะตะดะฝะธะต 30 ะดะฝะตะน)
- โ ะะต ะทะฐะฑะฐะฝะตะฝ
- โ **Username ะะ ััะตะฑัะตััั** (ััะปะพะฒะธะต ัะฑัะฐะฝะพ)

### 3. ะะบัะธะฒะฐัะธั ะธ ะะฐะณัะฐะดั

**ะะพะณะดะฐ ัะตัะตัะฐะป ะฐะบัะธะฒะธััะตััั:**

1. ะัะธะณะปะฐัะธัะตะปั (referrer) ะฟะพะปััะฐะตั:
   - โ +10 ะฑะพะฝััะฝัั ะทะฐะฟัะพัะพะฒ
   - ๐ ะะฑะฝะพะฒะปัะตััั ะตะณะพ tier (bronze/silver/gold/platinum)

2. ะกัะฐััั ัะตัะตัะฐะปะฐ ะผะตะฝัะตััั:
   - `PENDING` โ `ACTIVE`
   - ะฃััะฐะฝะฐะฒะปะธะฒะฐะตััั `activated_at` timestamp

## ะะฒัะพะผะฐัะธะทะฐัะธั

### Scheduler (APScheduler)

- **ะะตัะธะพะดะธัะฝะพััั:** ะบะฐะถะดัะต 30 ะผะธะฝัั
- **ะะฐะดะฐัะฐ:** `check_and_activate_referrals()`
- **ะคัะฝะบัะธั:** ะัะพะฒะตััะตั ะฒัะต `PENDING` ัะตัะตัะฐะปั ะธ ะฐะบัะธะฒะธััะตั ัะต, ะบะพัะพััะต ะฒัะฟะพะปะฝะธะปะธ ััะปะพะฒะธั

### ะัะพัะตัั ะัะพะฒะตัะบะธ

```python
# ะะฐะถะดัะต 30 ะผะธะฝัั
1. ะะพะปััะธัั ะฒัะต PENDING ัะตัะตัะฐะปั
2. ะะปั ะบะฐะถะดะพะณะพ ัะตัะตัะฐะปะฐ:
   - ะัะพะฒะตัะธัั ะบัะธัะตัะธะธ ะฐะบัะธะฒะฐัะธะธ
   - ะัะปะธ ะบัะธัะตัะธะธ ะฒัะฟะพะปะฝะตะฝั:
     * ะะฐัะธัะปะธัั +10 ะทะฐะฟัะพัะพะฒ ะฟัะธะณะปะฐัะธัะตะปั
     * ะฃััะฐะฝะพะฒะธัั ััะฐััั ACTIVE
     * ะะฑะฝะพะฒะธัั tier ะฟัะธะณะปะฐัะธัะตะปั
```

## ะคัะฝะบัะธะธ API

### ะะพะฒัะต ะคัะฝะบัะธะธ ะฒ `crud.py`

#### `grant_referee_bonus(session, referral_id) -> bool`
ะะฐัะธัะปัะตั ะฟัะธะฒะตัััะฒะตะฝะฝัะน ะฑะพะฝัั ะฝะพะฒะพะผั ะฟะพะปัะทะพะฒะฐัะตะปั (+5 ะทะฐะฟัะพัะพะฒ).
- ะัะทัะฒะฐะตััั ะกะะะะฃ ะฟัะธ ัะตะณะธัััะฐัะธะธ ัะตัะตะท ัะตัะตัะฐะปัะฝัั ัััะปะบั
- ะะฐัะธัะปัะตััั ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท (ะฟัะพะฒะตัะบะฐ `trial_granted`)

#### `grant_referrer_bonus(session, referral_id) -> bool`
ะะฐัะธัะปัะตั ะฑะพะฝัั ะฟัะธะณะปะฐัะธัะตะปั (+10 ะทะฐะฟัะพัะพะฒ).
- ะัะทัะฒะฐะตััั ะะะกะะ ะฐะบัะธะฒะฐัะธะธ ัะตัะตัะฐะปะฐ
- ะะฐัะธัะปัะตััั ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท (ะฟัะพะฒะตัะบะฐ `bonus_granted`)
- ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฑะฝะพะฒะปัะตั tier ะฟัะธะณะปะฐัะธัะตะปั

#### `check_referral_activation_criteria(session, referee_id) -> bool`
ะัะพะฒะตััะตั, ะฒัะฟะพะปะฝะตะฝั ะปะธ ััะปะพะฒะธั ะดะปั ะฐะบัะธะฒะฐัะธะธ ัะตัะตัะฐะปะฐ.
- ะะพะทะฒัะฐัะฐะตั `True` ะตัะปะธ ะฒัะต ะบัะธัะตัะธะธ ะฒัะฟะพะปะฝะตะฝั

#### `activate_pending_referral(session, referral_id) -> bool`
ะะบัะธะฒะธััะตั pending ัะตัะตัะฐะป ะธ ะฝะฐัะธัะปัะตั ะฑะพะฝัั ะฟัะธะณะปะฐัะธัะตะปั.
- ะัะพะฒะตััะตั ะบัะธัะตัะธะธ
- ะัะทัะฒะฐะตั `grant_referrer_bonus()`
- ะะฑะฝะพะฒะปัะตั ััะฐััั ะฝะฐ `ACTIVE`

#### `process_pending_referrals(session) -> dict`
ะะฐััะพะฒะฐั ะพะฑัะฐะฑะพัะบะฐ ะฒัะตั pending ัะตัะตัะฐะปะพะฒ.
- ะัะฟะพะปัะทัะตััั scheduler'ะพะผ
- ะะพะทะฒัะฐัะฐะตั ััะฐัะธััะธะบั: `{"checked": int, "activated": int, "failed": int}`

## ะะฝัะตะณัะฐัะธั

### 1. ะ `bot.py`

```python
from src.tasks.referral_scheduler import schedule_referral_tasks
from apscheduler.schedulers.asyncio import AsyncIOScheduler

# Startup
_scheduler = AsyncIOScheduler()
schedule_referral_tasks(_scheduler)
_scheduler.start()

# Shutdown
_scheduler.shutdown(wait=False)
```

### 2. ะ `start.py`

```python
from src.database.crud import grant_referee_bonus

# ะะพัะปะต ัะพะทะดะฐะฝะธั ัะตัะตัะฐะปะฐ
if referral:
    bonus_granted = await grant_referee_bonus(session, referral.id)
```

### 3. ะ `referral_scheduler.py`

```python
# ะะฐะดะฐัะฐ ะทะฐะฟััะบะฐะตััั ะบะฐะถะดัะต 30 ะผะธะฝัั
scheduler.add_job(
    check_and_activate_referrals,
    trigger='interval',
    minutes=30,
    ...
)
```

## ะกัะตะผะฐ ะะฐะฑะพัั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. ะะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะตัะตัะพะดะธั ะฟะพ ัะตัะตัะฐะปัะฝะพะน ัััะปะบะต       โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. ะกะพะทะดะฐะตััั Referral (status=PENDING)                      โ
โ    โ Referee ะฟะพะปััะฐะตั +15 ะทะฐะฟัะพัะพะฒ ะกะะะะฃ                    โ
โ    โ Referrer ะฟะพะปััะฐะตั ัะฒะตะดะพะผะปะตะฝะธะต                          โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. Referee ะธัะฟะพะปัะทัะตั ะฑะพัะฐ...                               โ
โ    (ะดะตะปะฐะตั ะทะฐะฟัะพัั, ะฟัะพัะพะดะธั ะฒัะตะผั)                         โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. Scheduler ะฟัะพะฒะตััะตั ะบะฐะถะดัะต 30 ะผะธะฝัั:                     โ
โ    โ ะัะพัะปะพ > 24 ัะฐัะฐ?                                      โ
โ    โ ะกะดะตะปะฐะฝะพ >= 5 ะทะฐะฟัะพัะพะฒ?                                 โ
โ    โ ะะต ะทะฐะฑะฐะฝะตะฝ?                                            โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
        โโโโโโโโโโโโโโโดโโโโโโโโโโโโโโ
        โ ะัะต ััะปะพะฒะธั ะฒัะฟะพะปะฝะตะฝั?    โ
        โโโโโโโฌโโโโโโโโโโโโโโโโฌโโโโโโ
              โ ะะ            โ ะะะข
              โผ               โผ
    โโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโ
    โ 5. ะะะขะะะะฆะะฏ:    โ   โ ะะถะธะดะฐะฝะธะต   โ
    โ โข Referrer +30   โ   โ ัะปะตะดัััะตะน  โ
    โ โข Status=ACTIVE  โ   โ ะฟัะพะฒะตัะบะธ   โ
    โ โข Tier Update    โ   โโโโโโโโโโโโโโ
    โโโโโโโโโโโโโโโโโโโโ
```

## ะัะตะธะผััะตััะฒะฐ ะะพะฒะพะน ะกะธััะตะผั

1. **ะะณะฝะพะฒะตะฝะฝะฐั ะฝะฐะณัะฐะดะฐ** - ะฝะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะปััะฐะตั ะฑะพะฝััั ััะฐะทั
2. **ะะฐัะธัะฐ ะพั ััะพะดะฐ** - ะฟัะธะณะปะฐัะธัะตะปั ะฟะพะปััะฐะตั ะฑะพะฝััั ัะพะปัะบะพ ะฟะพัะปะต ะฐะบัะธะฒะฐัะธะธ
3. **ะะฒัะพะผะฐัะธะทะฐัะธั** - ะฝะต ััะตะฑัะตั ัััะฝะพะณะพ ะฒะผะตัะฐัะตะปัััะฒะฐ
4. **ะกะฟัะฐะฒะตะดะปะธะฒะพััั** - ััะปะพะฒะธั ะฐะบัะธะฒะฐัะธะธ ะทะฐัะธัะฐัั ะพั fake ะฐะบะบะฐัะฝัะพะฒ
5. **ะะฐัััะฐะฑะธััะตะผะพััั** - scheduler ะพะฑัะฐะฑะฐััะฒะฐะตั ะฒัะต ัะตัะตัะฐะปั ะฐะฒัะพะผะฐัะธัะตัะบะธ

## ะะพะฝะธัะพัะธะฝะณ

### ะะพะณะธ

```python
# ะัะธ ัะตะณะธัััะฐัะธะธ
"Referral created: {referrer_id} โ {referee_id}"
"Welcome bonus granted to referee {user_id}: +15 requests"

# ะัะธ ะฟัะพะฒะตัะบะต scheduler'ะพะผ
"Processing {count} pending referrals"
"Referral {id} activated: {referrer_id} โ {referee_id}"
"Granted +30 bonus requests to referrer {id}"

# ะกัะฐัะธััะธะบะฐ
"Processed pending referrals: X activated, Y failed, Z total"
```

### ะะตััะธะบะธ

- `checked` - ะบะพะปะธัะตััะฒะพ ะฟัะพะฒะตัะตะฝะฝัั ัะตัะตัะฐะปะพะฒ
- `activated` - ะบะพะปะธัะตััะฒะพ ะฐะบัะธะฒะธัะพะฒะฐะฝะฝัั
- `failed` - ะบะพะปะธัะตััะฒะพ ะพัะธะฑะพะบ ะฟัะธ ะพะฑัะฐะฑะพัะบะต

## ะะธะณัะฐัะธั

ะัะธ ัะฐะทะฒะตัััะฒะฐะฝะธะธ ะพะฑะฝะพะฒะปะตะฝะธั:

1. โ Scheduler ะทะฐะฟัััะธััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
2. โ ะกััะตััะฒัััะธะต PENDING ัะตัะตัะฐะปั ะฑัะดัั ะฟัะพะฒะตัะตะฝั
3. โ ะะพะฒัะต ัะตัะตัะฐะปั ะฟะพะปััะฐั ะฑะพะฝััั ััะฐะทั ะฟัะธ ัะตะณะธัััะฐัะธะธ

## ะะตะทะพะฟะฐัะฝะพััั

### ะะฐัะธัะฐ ะพั ะะปะพัะฟะพััะตะฑะปะตะฝะธะน

1. **Double-check ะทะฐัะธัะฐ:**
   - `trial_granted` - ัะปะฐะณ ะดะปั referee ะฑะพะฝััะฐ
   - `bonus_granted` - ัะปะฐะณ ะดะปั referrer ะฑะพะฝััะฐ
   - ะะพะฝััั ะฝะฐัะธัะปััััั ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท

2. **ะฃัะปะพะฒะธั ะฐะบัะธะฒะฐัะธะธ:**
   - 24 ัะฐัะฐ - ะทะฐัะธัะฐ ะพั bot ะฐะบะบะฐัะฝัะพะฒ
   - 5 ะทะฐะฟัะพัะพะฒ - ะฟะพะดัะฒะตัะถะดะตะฝะธะต ัะตะฐะปัะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
   - ะะต ะทะฐะฑะฐะฝะตะฝ - ะทะฐัะธัะฐ ะพั ะฝะฐัััะธัะตะปะตะน

3. **Scheduler ะทะฐัะธัะฐ:**
   - `max_instances=1` - ะฟัะตะดะพัะฒัะฐัะฐะตั ะดัะฑะปะธัะพะฒะฐะฝะธะต
   - Error handling - ะฝะต ะปะพะผะฐะตััั ะฟัะธ ะพัะธะฑะบะฐั

## ะขะตััะธัะพะฒะฐะฝะธะต

ะะตะบะพะผะตะฝะดัะตััั ะฟัะพัะตััะธัะพะฒะฐัั:

1. โ ะะตะณะธัััะฐัะธั ัะตัะตะท ัะตัะตัะฐะปัะฝัั ัััะปะบั
2. โ ะะตะผะตะดะปะตะฝะฝะพะต ะฟะพะปััะตะฝะธะต +15 ะทะฐะฟัะพัะพะฒ referee
3. โ Scheduler ะฐะบัะธะฒะฐัะธั ะฟะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ััะปะพะฒะธะน
4. โ ะะพะปััะตะฝะธะต +30 ะทะฐะฟัะพัะพะฒ referrer ะฟะพัะปะต ะฐะบัะธะฒะฐัะธะธ
5. โ ะะฑะฝะพะฒะปะตะฝะธะต tier ะฟัะธะณะปะฐัะธัะตะปั

## ะะทะผะตะฝะตะฝะธั ะฒ ะคะฐะนะปะฐั

- [src/database/crud.py](../src/database/crud.py) - ะพะฑะฝะพะฒะปะตะฝั ััะฝะบัะธะธ ะฝะฐัะธัะปะตะฝะธั ะฑะพะฝััะพะฒ
- [src/bot/handlers/start.py](../src/bot/handlers/start.py) - ะดะพะฑะฐะฒะปะตะฝะพ ะฝะตะผะตะดะปะตะฝะฝะพะต ะฝะฐัะธัะปะตะฝะธะต ะฑะพะฝััะพะฒ
- [src/tasks/referral_scheduler.py](../src/tasks/referral_scheduler.py) - ะฝะพะฒัะน scheduler
- [bot.py](../bot.py) - ะธะฝัะตะณัะฐัะธั APScheduler
- [cryptoai/](../cryptoai/) - ะฒัะต ะธะทะผะตะฝะตะฝะธั ัะบะพะฟะธัะพะฒะฐะฝั ะฒ ะบะปะธะตะฝััะบัั ะฒะตััะธั
