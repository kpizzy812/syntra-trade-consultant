# üéØ SaaS Product Analysis - Syntra Trade Consultant

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-11-19
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ - –¢—Ä–µ–±—É—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
**–ê–Ω–∞–ª–∏—Ç–∏–∫:** Claude Code (Sonnet 4.5)

---

## üìä EXECUTIVE SUMMARY

**Syntra Trade Consultant** - –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å —Å–∏–ª—å–Ω—ã–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–æ–º, –Ω–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –≤ –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∞—Ö.

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: **7/10** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|----------|--------|--------|
| Product Vision | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ –°–∏–ª—å–Ω–∞—è |
| Tech Stack | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ –û—Ç–ª–∏—á–Ω—ã–π |
| Architecture | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è |
| **Unit Economics** | ‚≠ê‚≠ê | üö® **–ö–†–ò–¢–ò–ß–ù–û** |
| **Analytics** | ‚≠ê | üö® **–ö–†–ò–¢–ò–ß–ù–û** |
| Go-to-Market | ‚≠ê‚≠ê‚≠ê | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π |
| Security | ‚≠ê‚≠ê‚≠ê | ‚ö†Ô∏è –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å |
| Testing | ‚≠ê‚≠ê | ‚ö†Ô∏è –ù–∏–∑–∫–∏–π coverage |

### üî• Top 3 –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **Unit Economics –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞**: FREE tier –ø—Ä–∏–Ω–æ—Å–∏—Ç -$10/–≥–æ–¥ —É–±—ã—Ç–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**: –õ–µ—Ç–∏—Ç–µ –≤—Å–ª–µ–ø—É—é –±–µ–∑ –º–µ—Ç—Ä–∏–∫ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∏ retention
3. **Payment Flow**: 2-step –ø—Ä–æ—Ü–µ—Å—Å –≤–º–µ—Å—Ç–æ 1-step —Å–Ω–∏–∂–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏—é

---

## üéØ –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´

### 1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

#### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

**Backend (Python)**
```python
‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
   Handlers ‚Üí Middleware ‚Üí Services ‚Üí Data Layer

‚úÖ Async-first –ø–æ–¥—Ö–æ–¥:
   - SQLAlchemy 2.0 —Å asyncpg
   - AsyncOpenAI –¥–ª—è AI –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã

‚úÖ –ì—Ä–∞–º–æ—Ç–Ω–∞—è middleware —Å–∏—Å—Ç–µ–º–∞:
   - DatabaseMiddleware (DB session injection)
   - SubscriptionMiddleware (channel check)
   - RequestLimitMiddleware (rate limiting)
   - LanguageMiddleware (i18n)
   - AdminMiddleware (RBAC)
   - LoggingMiddleware (audit trail)

‚úÖ Dependency Injection:
   - –ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
   - –õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å
```

**Frontend (Next.js)**
```typescript
‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫:
   - Next.js 16 (latest)
   - React 19 —Å Suspense
   - TypeScript –¥–ª—è type safety
   - TailwindCSS 4 (–Ω–æ–≤–µ–π—à–∞—è –≤–µ—Ä—Å–∏—è)
   - Zustand –¥–ª—è state management

‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
   - Framer Motion –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
   - SWR –¥–ª—è data fetching
   - next-intl –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
   - TON Connect –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
```

**Database (PostgreSQL)**
```sql
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ë–î (3NF)
   - Foreign keys —Å ON DELETE CASCADE
   - –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—è—Ö
   - Unique constraints –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏:
   - Alembic –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - Rollback capability
   - Auto-generate –æ—Ç –º–æ–¥–µ–ª–µ–π
```

**–ö–æ–¥-—Å—Ç–∏–ª—å:**
```
‚úÖ 534K —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã:
   /src/bot/handlers/     - Telegram handlers
   /src/api/              - FastAPI endpoints
   /src/services/         - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
   /src/database/         - CRUD operations
   /frontend/components/  - React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
   /tests/                - Unit —Ç–µ—Å—Ç—ã
```

---

### 2. Product Vision ‚≠ê‚≠ê‚≠ê‚≠ê

#### Value Proposition
```
üéØ –ü—Ä–æ–±–ª–µ–º–∞: –ö—Ä–∏–ø—Ç–æ-—Ç—Ä–µ–π–¥–µ—Ä—ã —Ç–æ–Ω—É—Ç –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
‚úÖ –†–µ—à–µ–Ω–∏–µ: AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞ –≤–∞—Å

–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:
‚îú‚îÄ –ü–µ—Ä—Å–æ–Ω–∞ "Syntra" (—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π)
‚îú‚îÄ –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (CoinGecko, Binance, CryptoPanic)
‚îú‚îÄ Vision-–∞–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —á–µ—Ä–µ–∑ OpenAI GPT-4o
‚îú‚îÄ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (RSI, MACD, Bollinger Bands)
‚îî‚îÄ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (RU/EN)
```

#### Target Audience
```
–û—Å–Ω–æ–≤–Ω–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:
‚îú‚îÄ –ù–∞—á–∏–Ω–∞—é—â–∏–µ —Ç—Ä–µ–π–¥–µ—Ä—ã (–Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –≤ –∞–Ω–∞–ª–∏–∑–µ)
‚îú‚îÄ –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–π–¥–µ—Ä—ã (—ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏)
‚îî‚îÄ Crypto enthusiasts (–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç)

–ö–∞–Ω–∞–ª: Telegram Mini App
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è crypto-–∞—É–¥–∏—Ç–æ—Ä–∏–∏
‚úÖ –ù–∏–∑–∫–∏–π –±–∞—Ä—å–µ—Ä –≤—Ö–æ–¥–∞ (—É–∂–µ –≤ Telegram)
‚úÖ Native payments —á–µ—Ä–µ–∑ Stars + TON
```

---

### 3. –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è ‚≠ê‚≠ê‚≠ê‚≠ê

#### Tier —Å–∏—Å—Ç–µ–º–∞
```
FREE:    5 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å  ‚Üí $0
BASIC:   20 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å ‚Üí $4.99/–º–µ—Å
PREMIUM: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å ‚Üí $24.99/–º–µ—Å
VIP:     ‚àû –±–µ–∑–ª–∏–º–∏—Ç       ‚Üí $49.99/–º–µ—Å

–î–∏—Å–∫–∞—É–Ω—Ç—ã:
‚îú‚îÄ 3 –º–µ—Å—è—Ü–∞: -15%
‚îú‚îÄ 12 –º–µ—Å—è—Ü–µ–≤: -25%
‚îî‚îÄ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏: 10-30%
```

#### Payment Integration
```
‚úÖ Telegram Stars (Priority #1):
   - –ù–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –ù–∏–∑–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è (~3-5%)
   - –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

‚úÖ TON Connect (Priority #2):
   - –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (TON/USDT)
   - –î–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è
   - –ö–æ–º–∏—Å—Å–∏—è <1%
```

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –¢—Ä–∞—Ñ–∏–∫-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
```
üéØ –¶–µ–ª—å: –ù–ï –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏, –∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º—É

–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
‚îú‚îÄ –ú–∞—Ä–∂–∞ –≤—Å–µ–≥–æ 34% (–Ω–∏–∑–∫–∞—è –¥–ª—è SaaS)
‚îú‚îÄ –ê–∫—Ü–µ–Ω—Ç –Ω–∞ viral growth —á–µ—Ä–µ–∑ referral program
‚îî‚îÄ –ü–µ—Ä–µ–ª–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã
```

---

## üö® –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. Unit Economics - –ö–ê–¢–ê–°–¢–†–û–§–ê üî•üî•üî•

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

**FREE Tier (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)**
```python
–ó–∞–ø—Ä–æ—Å—ã: 5/–¥–µ–Ω—å √ó 30 –¥–Ω–µ–π = 150 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å

–ó–∞—Ç—Ä–∞—Ç—ã:
‚îú‚îÄ AI (gpt-4o-mini): 150 √ó $0.005 = $0.75
‚îú‚îÄ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: $0.08
‚îî‚îÄ –ò–¢–û–ì–û: $0.83/–º–µ—Å —É–±—ã—Ç–∫–∞

–ì–æ–¥–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏: $0.83 √ó 12 = -$10/–≥–æ–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

‚ö†Ô∏è –ü—Ä–∏ 1000 FREE users = -$10,000/–≥–æ–¥
‚ö†Ô∏è –ü—Ä–∏ 10,000 FREE users = -$100,000/–≥–æ–¥
```

**–ü–ª–∞—Ç–Ω—ã–µ —Ç–∏—Ä—ã (–º–∞—Ä–∂–∞)**
```
–ú–∞—Ä–∂–∞: –≤—Å–µ–≥–æ 34%

BASIC ($4.99):
‚îú‚îÄ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: $3.30
‚îî‚îÄ –ü—Ä–∏–±—ã–ª—å: $1.69/–º–µ—Å (34%)

PREMIUM ($24.99):
‚îú‚îÄ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: $16.50
‚îî‚îÄ –ü—Ä–∏–±—ã–ª—å: $8.49/–º–µ—Å (34%)

VIP ($49.99):
‚îú‚îÄ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: $33.00
‚îî‚îÄ –ü—Ä–∏–±—ã–ª—å: $16.99/–º–µ—Å (34%)

‚ö†Ô∏è 34% - —ç—Ç–æ –û–ß–ï–ù–¨ –ù–ò–ó–ö–û –¥–ª—è SaaS
   –ù–æ—Ä–º–∞: 70-80% gross margin
```

#### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ:

```
1. –ù–µ–≥–∞—Ç–∏–≤–Ω–∞—è —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞ –Ω–∞ FREE tier
   ‚Üí –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = —É–±—ã—Ç–æ–∫

2. –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è FREE ‚Üí PAID (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞!)
   ‚Üí –ï—Å–ª–∏ <10%, —Ç–æ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å –ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º

3. Revenue Share 10-15% —Å—ä–µ—Å—Ç –æ—Å—Ç–∞—Ç–∫–∏ –º–∞—Ä–∂–∏
   ‚Üí 34% - 15% = 19% –∏—Ç–æ–≥–æ–≤–∞—è –º–∞—Ä–∂–∞

4. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ CAC –∏ LTV
   ‚Üí –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å ROI
```

#### üî• –°–†–û–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:

**–î–µ–π—Å—Ç–≤–∏–µ #1: –°–æ–∫—Ä–∞—Ç–∏—Ç—å FREE tier**
```diff
- FREE: 5 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å (150/–º–µ—Å)
+ FREE: 3 –∑–∞–ø—Ä–æ—Å–∞/–¥–µ–Ω—å (90/–º–µ—Å)

–≠–∫–æ–Ω–æ–º–∏—è:
‚îú‚îÄ –ë—ã–ª–æ: $0.75 AI cost
‚îú‚îÄ –°—Ç–∞–ª–æ: $0.45 AI cost
‚îî‚îÄ –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —É–±—ã—Ç–∫–∞: 40%

–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
‚úÖ 3 –∑–∞–ø—Ä–æ—Å–∞/–¥–µ–Ω—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è "try before buy"
‚úÖ –ú–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –∞–ø–≥—Ä–µ–π–¥ —Ä–∞–Ω—å—à–µ
‚úÖ –°–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
```

**–î–µ–π—Å—Ç–≤–∏–µ #2: –ñ–µ—Å—Ç–∫–∏–π —Ä–æ—É—Ç–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π**
```python
# –¢–µ–∫—É—â–∏–π –∫–æ–¥ (openai_service.py):
def _select_model(self, messages: list) -> str:
    total_tokens = sum(count_tokens(m['content']) for m in messages)
    return "gpt-4o" if total_tokens > 1500 else "gpt-4o-mini"

# ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: FREE users –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å gpt-4o!

# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:
def _select_model(self, messages: list, user_tier: str) -> str:
    # FREE –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç gpt-4o-mini
    if user_tier == "free":
        return "gpt-4o-mini"

    # BASIC —Ç–æ–∂–µ —Ç–æ–ª—å–∫–æ mini
    if user_tier == "basic":
        return "gpt-4o-mini"

    # PREMIUM+ –ø–æ–ª—É—á–∞—é—Ç —Ä–æ—É—Ç–∏–Ω–≥
    total_tokens = sum(count_tokens(m['content']) for m in messages)
    return "gpt-4o" if total_tokens > 1500 else "gpt-4o-mini"
```

**–î–µ–π—Å—Ç–≤–∏–µ #3: Hard limits –Ω–∞ —Ç–æ–∫–µ–Ω—ã**
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ config:
TOKEN_LIMITS = {
    "free": {
        "max_input": 500,   # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–ª–∏–Ω—É –ø—Ä–æ–º–ø—Ç–∞
        "max_output": 500,  # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
    },
    "basic": {
        "max_input": 1000,
        "max_output": 1000,
    },
    "premium": {
        "max_input": 3000,
        "max_output": 2000,
    },
    "vip": {
        "max_input": None,  # –ë–µ–∑–ª–∏–º–∏—Ç
        "max_output": None,
    }
}

# –í openai_service.py:
async def get_completion(self, messages, user_tier):
    limits = TOKEN_LIMITS[user_tier]

    # –û–±—Ä–µ–∑–∞—Ç—å –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if limits["max_input"]:
        messages = truncate_messages(messages, limits["max_input"])

    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å max_tokens
    response = await self.client.chat.completions.create(
        model=self._select_model(messages, user_tier),
        messages=messages,
        max_tokens=limits["max_output"],
        stream=stream
    )
```

**–î–µ–π—Å—Ç–≤–∏–µ #4: Aggressive caching**
```python
# –£–∂–µ –µ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ system prompt (50% —ç–∫–æ–Ω–æ–º–∏—è)
# –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

COMMON_QUERIES_CACHE = {
    "bitcoin price": TTL 60 —Å–µ–∫—É–Ω–¥,
    "ethereum analysis": TTL 5 –º–∏–Ω—É—Ç,
    "top movers": TTL 10 –º–∏–Ω—É—Ç,
}

# –≠–∫–æ–Ω–æ–º–∏—è: ~20% –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–∞—Ö
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–¢–µ–∫—É—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã FREE: $0.83/–º–µ—Å
–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
‚îú‚îÄ 3 –∑–∞–ø—Ä–æ—Å–∞/–¥–µ–Ω—å: -40% = $0.50
‚îú‚îÄ –ñ–µ—Å—Ç–∫–∏–π mini: -30% = $0.35
‚îú‚îÄ Token limits: -20% = $0.28
‚îî‚îÄ Caching: -10% = $0.25/–º–µ—Å

–ò–¢–û–ì–û: –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —É–±—ã—Ç–∫–∞ –Ω–∞ 70%! üéâ
```

---

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Product Analytics üî•üî•üî•

#### –ß—Ç–æ –≤—ã –ù–ï –∑–Ω–∞–µ—Ç–µ –æ —Å–≤–æ–µ–º –ø—Ä–æ–¥—É–∫—Ç–µ:

**1. Conversion Funnel**
```
‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ:
‚îú‚îÄ –°–∫–æ–ª—å–∫–æ % FREE ‚Üí BASIC –∫–æ–Ω–≤–µ—Ä—Å–∏—è?
‚îú‚îÄ –°–∫–æ–ª—å–∫–æ % BASIC ‚Üí PREMIUM –∞–ø–≥—Ä–µ–π–¥?
‚îú‚îÄ –ù–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –æ—Ç–≤–∞–ª–∏–≤–∞—é—Ç—Å—è?
‚îú‚îÄ –ö–∞–∫–∏–µ —Ñ–∏—á–∏ –≤–ª–∏—è—é—Ç –Ω–∞ conversion?
‚îî‚îÄ –ö–∞–∫ discount –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–∫—É–ø–∫—É?

‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
Telegram ‚Üí Start ‚Üí AI Request ‚Üí Limit Hit ‚Üí Pricing Page ‚Üí Checkout ‚Üí PAID
   100%      95%       80%         60%         40%          30%       10%

   Drop-off analysis –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ!
```

**2. Retention Metrics**
```
‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ:
‚îú‚îÄ DAU (Daily Active Users)
‚îú‚îÄ WAU (Weekly Active Users)
‚îú‚îÄ MAU (Monthly Active Users)
‚îú‚îÄ D1, D7, D30 retention
‚îú‚îÄ Cohort retention curves
‚îî‚îÄ Churn rate –ø–æ —Ç–∏—Ä–∞–º

‚úÖ Benchmark –¥–ª—è SaaS:
Day 1:  40-50%
Day 7:  20-30%
Day 30: 10-15%
```

**3. Feature Usage**
```
‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ:
‚îú‚îÄ –ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —á–∞—â–µ –≤—Å–µ–≥–æ?
‚îú‚îÄ –ö–∞–∫–∏–µ –º–æ–Ω–µ—Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç?
‚îú‚îÄ –ò—Å–ø–æ–ª—å–∑—É—é—Ç –ª–∏ Vision API?
‚îú‚îÄ –ß–∏—Ç–∞—é—Ç –ª–∏ –Ω–æ–≤–æ—Å—Ç–∏?
‚îî‚îÄ –ö–∞–∫–∏–µ —Ñ–∏—á–∏ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç —Å conversion?

‚úÖ –ù—É–∂–Ω–æ —Ç—Ä–µ–∫–∞—Ç—å:
- /price –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (top coins)
- /analyze —á–∞—Å—Ç–æ—Ç–∞
- Vision uploads
- –í—Ä–µ–º—è –≤ —á–∞—Ç–µ
- Message depth
```

**4. User Segments**
```
‚ùå –ù–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏:
‚îú‚îÄ Power users vs Lurkers
‚îú‚îÄ Bitcoin maximalists vs Altcoin traders
‚îú‚îÄ Day traders vs HODL investors
‚îú‚îÄ Premium vs FREE behavior patterns
‚îî‚îÄ Referral bringers vs Solo users

‚úÖ –°–µ–≥–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è:
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
- Feature prioritization
- Targeted retention campaigns
```

#### üî• –°–†–û–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:

**–î–µ–π—Å—Ç–≤–∏–µ #1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostHog (1 –¥–µ–Ω—å)**

```bash
# Backend integration
pip install posthog

# config/config.py
POSTHOG_API_KEY = os.getenv("POSTHOG_API_KEY")
POSTHOG_HOST = "https://app.posthog.com"

# src/services/analytics_service.py
from posthog import Posthog

posthog = Posthog(
    project_api_key=POSTHOG_API_KEY,
    host=POSTHOG_HOST
)

class AnalyticsService:
    @staticmethod
    def track_event(user_id: int, event: str, properties: dict = None):
        """Track user event"""
        posthog.capture(
            distinct_id=str(user_id),
            event=event,
            properties=properties or {}
        )

    @staticmethod
    def identify_user(user_id: int, traits: dict):
        """Identify user with traits"""
        posthog.identify(
            distinct_id=str(user_id),
            properties=traits
        )
```

**–î–µ–π—Å—Ç–≤–∏–µ #2: –î–æ–±–∞–≤–∏—Ç—å event tracking**

```python
# –°–æ–±—ã—Ç–∏—è –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞:

# 1. User Lifecycle
analytics.track_event(user.id, "user_registered", {
    "source": "telegram",
    "language": user.language,
    "referred_by": user.referred_by_id,
})

analytics.track_event(user.id, "user_subscribed_channel", {
    "channel": REQUIRED_CHANNEL,
})

# 2. AI Interactions
analytics.track_event(user.id, "ai_request_sent", {
    "command": message.text[:20],  # First 20 chars
    "tier": user.subscription.tier,
    "tokens_used": response.usage.total_tokens,
    "model": "gpt-4o-mini",
    "cost": calculated_cost,
})

analytics.track_event(user.id, "vision_analysis_requested", {
    "tier": user.subscription.tier,
})

# 3. Crypto Operations
analytics.track_event(user.id, "price_checked", {
    "coin": coin_id,
    "price": current_price,
})

analytics.track_event(user.id, "coin_analyzed", {
    "coin": coin_id,
    "analysis_type": "full",
})

# 4. Limits & Subscription
analytics.track_event(user.id, "limit_hit", {
    "tier": user.subscription.tier,
    "requests_used": limit_record.count,
    "limit": limit_record.limit,
})

analytics.track_event(user.id, "pricing_page_viewed", {
    "current_tier": user.subscription.tier,
})

analytics.track_event(user.id, "subscription_purchased", {
    "tier": tier,
    "duration_months": duration,
    "amount": amount,
    "provider": provider,
    "is_upgrade": is_upgrade,
})

# 5. Referrals
analytics.track_event(user.id, "referral_link_shared", {
    "referral_code": user.referral_code,
})

analytics.track_event(user.id, "referral_activated", {
    "referee_id": referee.id,
})
```

**–î–µ–π—Å—Ç–≤–∏–µ #3: –°–æ–∑–¥–∞—Ç—å dashboards**

```yaml
# PostHog Dashboards:

Dashboard 1: "Acquisition Funnel"
‚îú‚îÄ Registered users (daily/weekly)
‚îú‚îÄ Channel subscription rate
‚îú‚îÄ First AI request rate
‚îú‚îÄ Source attribution (organic vs referral)
‚îî‚îÄ Cost per acquisition (if –µ—Å—Ç—å paid ads)

Dashboard 2: "Engagement"
‚îú‚îÄ DAU / WAU / MAU
‚îú‚îÄ Requests per user (avg)
‚îú‚îÄ Top commands usage
‚îú‚îÄ Top analyzed coins
‚îî‚îÄ Session length distribution

Dashboard 3: "Conversion"
‚îú‚îÄ FREE ‚Üí BASIC conversion rate
‚îú‚îÄ BASIC ‚Üí PREMIUM upgrade rate
‚îú‚îÄ Time to first purchase
‚îú‚îÄ Discount impact analysis
‚îî‚îÄ Referral conversion rate

Dashboard 4: "Retention"
‚îú‚îÄ D1, D7, D30 retention curves
‚îú‚îÄ Cohort retention heatmap
‚îú‚îÄ Churn rate by tier
‚îú‚îÄ Feature usage correlation with retention
‚îî‚îÄ Win-back campaign effectiveness

Dashboard 5: "Revenue"
‚îú‚îÄ MRR (Monthly Recurring Revenue)
‚îú‚îÄ ARPU (Average Revenue Per User)
‚îú‚îÄ LTV (Lifetime Value) by cohort
‚îú‚îÄ CAC payback period
‚îî‚îÄ Revenue by tier breakdown
```

**–î–µ–π—Å—Ç–≤–∏–µ #4: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å alerts**

```python
# PostHog Alerts –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

Alert 1: "Conversion Drop"
‚îú‚îÄ Trigger: FREE ‚Üí PAID conversion < 5%
‚îî‚îÄ Notify: Slack/Email

Alert 2: "Churn Spike"
‚îú‚îÄ Trigger: Daily churn > 5%
‚îî‚îÄ Notify: Slack/Email

Alert 3: "API Errors"
‚îú‚îÄ Trigger: OpenAI error rate > 2%
‚îî‚îÄ Notify: PagerDuty

Alert 4: "Limit Hit Surge"
‚îú‚îÄ Trigger: Limit hits > 100/hour
‚îî‚îÄ Notify: Slack (potential viral growth!)
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Visibility –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
‚úÖ Data-driven —Ä–µ—à–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –≥–∞–¥–∞–Ω–∏–π
‚úÖ A/B testing –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã
‚úÖ –ü–æ–Ω–∏–º–∞–Ω–∏–µ —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —á—Ç–æ –Ω–µ—Ç
```

---

### 3. Payment Flow –Ω–µ–æ–ø—Ç–∏–º–∞–ª–µ–Ω üî•üî•

#### –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

**–§–∞–π–ª:** `src/api/payment.py:107-148`

```python
@router.post("/stars/create-invoice")
async def create_stars_invoice(...):
    # ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: Invoice –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É!

    return PaymentResponse(
        success=True,
        message="Invoice request received. Sending invoice via bot...",
        data={
            "tier": tier.value,
            "duration_months": request.duration_months,
            "price_stars": plan["stars"],
            # ... –Ω–æ invoice –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!
        }
    )
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å:**
```
User flow (2 steps):
1. Frontend ‚Üí API /payment/stars/create-invoice
   ‚îú‚îÄ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "Invoice request received"
   ‚îî‚îÄ –ù–æ invoice –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!

2. Frontend ‚Üí ??? (–¥–æ–ª–∂–µ–Ω –∫–∞–∫-—Ç–æ –≤—ã–∑–≤–∞—Ç—å –±–æ—Ç–∞)
   ‚îî‚îÄ Confusion! –ì–¥–µ invoice?

Result: High drop-off rate
```

#### –ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:

```
‚ùå 2-step –ø—Ä–æ—Ü–µ—Å—Å –≤–º–µ—Å—Ç–æ 1-step
   ‚Üí –ö–∞–∂–¥—ã–π —à–∞–≥ = –ø–æ—Ç–µ—Ä—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
   ‚Üí 2 —à–∞–≥–∞ = –ø–æ—Ç–µ—Ä—è ~30% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

‚ùå Confusing UX
   ‚Üí "Invoice request received" - —á—Ç–æ –¥–∞–ª—å—à–µ?
   ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥

‚ùå –ù–µ—Ç fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞
   ‚Üí –ß—Ç–æ –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–π —à–∞–≥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç?
   ‚Üí Lost sale
```

#### üî• –†–ï–®–ï–ù–ò–ï:

**–í–∞—Ä–∏–∞–Ω—Ç A: Send invoice immediately (Recommended)**

```python
@router.post("/stars/create-invoice")
async def create_stars_invoice(
    request: CreateStarsInvoiceRequest,
    user: User = Depends(get_current_user),
    session: AsyncSession = Depends(get_session),
):
    """
    Create and SEND Telegram Stars invoice immediately
    """
    try:
        # Validate tier and duration
        tier = SubscriptionTier(request.tier)
        if request.duration_months not in [1, 3, 12]:
            raise HTTPException(status_code=400, detail="Invalid duration")

        # Get plan details
        plan = stars_service.get_plan_details(tier, request.duration_months)

        # Initialize bot
        from aiogram import Bot
        from config.config import BOT_TOKEN
        bot = Bot(token=BOT_TOKEN)

        try:
            # ‚úÖ CREATE AND SEND INVOICE IMMEDIATELY
            from aiogram.types import LabeledPrice

            invoice = await bot.send_invoice(
                chat_id=user.telegram_id,
                title=f"Syntra {tier.value.upper()} Subscription",
                description=f"{tier.value.upper()} tier - {request.duration_months} month(s)",
                payload=f"sub_{user.id}_{tier.value}_{request.duration_months}",
                provider_token="",  # Empty for Telegram Stars
                currency="XTR",
                prices=[LabeledPrice(
                    label=f"{request.duration_months} month(s)",
                    amount=plan["stars"]
                )],
                start_parameter=f"subscribe_{tier.value}"
            )

            # Save payment record (PENDING status)
            from src.database.crud import create_payment
            payment = await create_payment(
                session=session,
                user_id=user.id,
                provider="telegram_stars",
                tier=tier.value,
                duration_months=request.duration_months,
                amount=plan["usd"],
                provider_payment_id=None,  # Will be set on success
            )

            logger.info(
                f"Invoice sent to user {user.id}: "
                f"tier={tier.value}, amount={plan['stars']} Stars"
            )

            return PaymentResponse(
                success=True,
                message="Invoice sent! Check your Telegram chat.",
                data={
                    "invoice_sent": True,
                    "payment_id": payment.id,
                    "tier": tier.value,
                    "duration_months": request.duration_months,
                    "price_stars": plan["stars"],
                    "price_usd": plan["usd"],
                }
            )

        finally:
            await bot.session.close()

    except HTTPException:
        raise
    except Exception as e:
        logger.exception(f"Error creating Stars invoice: {e}")
        raise HTTPException(
            status_code=500,
            detail="Failed to create invoice"
        )
```

**–í–∞—Ä–∏–∞–Ω—Ç B: Webhook approach (–¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)**

```python
# –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ API —Å–µ—Ä–≤–µ—Ä–∞,
# –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å webhook –∏–ª–∏ message queue:

@router.post("/stars/create-invoice")
async def create_stars_invoice(...):
    # –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ Redis/RabbitMQ
    task_id = await invoice_queue.enqueue(
        "send_telegram_invoice",
        user_id=user.id,
        tier=tier.value,
        duration_months=request.duration_months,
    )

    return PaymentResponse(
        success=True,
        message="Invoice is being sent...",
        data={"task_id": task_id}
    )

# Worker –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç invoice
```

**–î–æ–±–∞–≤–∏—Ç—å Pre-checkout handler:**

```python
# src/bot/handlers/payment.py

from aiogram import Router, F
from aiogram.types import PreCheckoutQuery

router = Router()

@router.pre_checkout_query()
async def process_pre_checkout(
    pre_checkout_query: PreCheckoutQuery,
    session: AsyncSession
):
    """
    Handle pre-checkout query (validate before payment)
    """
    # Parse payload
    payload = pre_checkout_query.invoice_payload
    # Format: "sub_{user_id}_{tier}_{duration}"

    try:
        parts = payload.split("_")
        user_id = int(parts[1])
        tier = parts[2]
        duration = int(parts[3])

        # Validate user exists
        user = await get_user_by_id(session, user_id)
        if not user:
            await pre_checkout_query.answer(
                ok=False,
                error_message="User not found"
            )
            return

        # Validate tier
        if tier not in ["basic", "premium", "vip"]:
            await pre_checkout_query.answer(
                ok=False,
                error_message="Invalid subscription tier"
            )
            return

        # All good - approve
        await pre_checkout_query.answer(ok=True)

    except Exception as e:
        logger.error(f"Pre-checkout validation failed: {e}")
        await pre_checkout_query.answer(
            ok=False,
            error_message="Validation failed"
        )
```

**–î–æ–±–∞–≤–∏—Ç—å Successful payment handler:**

```python
@router.message(F.successful_payment)
async def process_successful_payment(
    message: Message,
    session: AsyncSession
):
    """
    Handle successful payment (activate subscription)
    """
    payment_info = message.successful_payment

    # Parse payload
    payload = payment_info.invoice_payload
    parts = payload.split("_")
    user_id = int(parts[1])
    tier = parts[2]
    duration_months = int(parts[3])

    try:
        # Get user
        user = await get_user_by_id(session, user_id)

        # Update payment record
        from src.database.crud import update_payment_status
        await update_payment_status(
            session=session,
            user_id=user_id,
            provider_payment_id=payment_info.telegram_payment_charge_id,
            status="completed",
        )

        # Activate subscription
        from src.database.crud import create_or_update_subscription
        from datetime import datetime, timedelta

        expires_at = datetime.utcnow() + timedelta(days=30 * duration_months)

        subscription = await create_or_update_subscription(
            session=session,
            user_id=user_id,
            tier=tier,
            expires_at=expires_at,
            is_active=True,
        )

        # Send confirmation
        await message.answer(
            f"üéâ Subscription activated!\n\n"
            f"Tier: {tier.upper()}\n"
            f"Duration: {duration_months} month(s)\n"
            f"Expires: {expires_at.strftime('%Y-%m-%d')}\n\n"
            f"Thank you for your purchase! üíé"
        )

        # Track event
        from src.services.analytics_service import analytics
        analytics.track_event(user_id, "subscription_purchased", {
            "tier": tier,
            "duration_months": duration_months,
            "amount": payment_info.total_amount / 100,  # Convert from cents
            "provider": "telegram_stars",
        })

    except Exception as e:
        logger.exception(f"Error processing payment: {e}")
        await message.answer(
            "‚ö†Ô∏è Payment received but activation failed. "
            "Please contact support."
        )
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ 1-step payment flow
‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
‚úÖ Proper error handling
‚úÖ Analytics tracking
‚úÖ –ö–æ–Ω–≤–µ—Ä—Å–∏—è —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ ~30%
```

---

### 4. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ - Over-engineered üî•

#### –¢–µ–∫—É—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å:

**–î–æ–∫—É–º–µ–Ω—Ç:** `docs/REFERRAL_SYSTEM_PROGRESS.md`

```
Tier —Å–∏—Å—Ç–µ–º–∞:
‚îú‚îÄ Bronze (0-4 referrals): 0 bonus, 0% discount, 0% revenue share
‚îú‚îÄ Silver (5-14 referrals): +50/–º–µ—Å, 10% discount, 0% share
‚îú‚îÄ Gold (15-49 referrals): +150/–º–µ—Å, 20% discount, 10% share
‚îî‚îÄ Platinum (50+ referrals): +500/–º–µ—Å, 30% discount, 15% share

+ Revenue share —Å–∏—Å—Ç–µ–º–∞
+ Balance —Å–∏—Å—Ç–µ–º–∞ (withdrawal –≤ TON)
+ Leaderboard
+ Achievements
+ Challenges
```

#### –ü—Ä–æ–±–ª–µ–º—ã:

**1. Fraud —Ä–∏—Å–∫ –û–ì–†–û–ú–ù–´–ô**
```python
# –¢–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞:
‚úÖ 24 —á–∞—Å–∞ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚úÖ –ú–∏–Ω–∏–º—É–º 5 –∑–∞–ø—Ä–æ—Å–æ–≤
‚úÖ –ù–µ –∑–∞–±–∞–Ω–µ–Ω
‚úÖ –ò–º–µ–µ—Ç username

‚ùå –õ–µ–≥–∫–æ –æ–±–æ–π—Ç–∏:
   - –°–æ–∑–¥–∞—Ç—å 50 –∞–∫–∫–∞—É–Ω—Ç–æ–≤
   - –ü–æ–¥–æ–∂–¥–∞—Ç—å 24 —á–∞—Å–∞
   - –°–¥–µ–ª–∞—Ç—å –ø–æ 5 –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ü–æ–ª—É—á–∏—Ç—å Platinum tier + 15% revenue share

‚ùå –ù–µ—Ç –∑–∞—â–∏—Ç—ã:
   - IP tracking (–æ—Ç–ª–æ–∂–µ–Ω–æ –Ω–∞ Phase 2)
   - Device fingerprinting
   - Behavioral analysis
   - Manual review –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```

**2. Revenue share —É–±—å–µ—Ç –º–∞—Ä–∂—É**
```
–¢–µ–∫—É—â–∞—è –º–∞—Ä–∂–∞: 34%
–ü–æ—Å–ª–µ 15% revenue share: 34% - 15% = 19%

‚ö†Ô∏è 19% –º–∞—Ä–∂–∞ = –Ω–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ
   SaaS –Ω–æ—Ä–º–∞: 70-80%

‚ö†Ô∏è –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ –ø—Ä–æ–±–ª–µ–º–∞ —É—Å—É–≥—É–±–∏—Ç—Å—è:
   - 100 Platinum users √ó 15% share
   - = –û—Ç–¥–∞—á–∞ 15% –≤—Å–µ–≥–æ –¥–æ—Ö–æ–¥–∞
```

**3. –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤ –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏**
```
‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–Ω—è—Ç—å:
   - 4 tier —É—Ä–æ–≤–Ω—è
   - 3 —Ç–∏–ø–∞ –Ω–∞–≥—Ä–∞–¥ (bonus requests, discount, revenue share)
   - Balance —Å–∏—Å—Ç–µ–º—É
   - Withdrawal –ø—Ä–æ—Ü–µ—Å—Å
   - –£—Å–ª–æ–≤–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
   ‚Üí Low adoption rate
```

**4. ROI –ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º**
```
Gold tier (15 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤):

–ó–∞—Ç—Ä–∞—Ç—ã:
‚îú‚îÄ –ù–∞—á–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã: $3.38
‚îú‚îÄ Monthly bonus: $0.75/–º–µ—Å
‚îú‚îÄ Revenue share: $4.00/–º–µ—Å
‚îî‚îÄ –ò—Ç–æ–≥–æ: $60.38/–≥–æ–¥

–î–æ—Ö–æ–¥:
‚îî‚îÄ $146.76/–≥–æ–¥ (–ø—Ä–∏ 20% conversion)

ROI: 143%

‚ö†Ô∏è –ù–û: 20% conversion - —ç—Ç–æ assumption!
‚ö†Ô∏è –ë–µ–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –º—ã –ù–ï –ó–ù–ê–ï–ú —Ä–µ–∞–ª—å–Ω—É—é conversion
```

#### üî• –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ MVP

**–§–∞–∑–∞ 1: –ü—Ä–æ—Å—Ç–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å)**

```python
# –ë–∞–∑–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:

–ù–æ–≤—ã–π –¥—Ä—É–≥ (referee):
‚îî‚îÄ +15 –±–æ–Ω—É—Å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)
   –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: $0.075

–†–µ—Ñ–µ—Ä–µ—Ä (referrer):
‚îî‚îÄ +30 –±–æ–Ω—É—Å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)
   –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: $0.150

–ò–¢–û–ì–û –Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞: $0.225

‚úÖ –ü—Ä–æ—Å—Ç–æ
‚úÖ –ü–æ–Ω—è—Ç–Ω–æ
‚úÖ –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ fraud
‚úÖ –ò–∑–º–µ—Ä–∏–º–æ
```

**–ß—Ç–æ —É–±—Ä–∞—Ç—å –∏–∑ v1.0:**
```
‚ùå Tier —Å–∏—Å—Ç–µ–º–∞ (Bronze/Silver/Gold/Platinum)
   ‚Üí –°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ, –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ

‚ùå Revenue share
   ‚Üí Fraud —Ä–∏—Å–∫ –≤—ã—Å–æ–∫–∏–π, –º–∞—Ä–∂–∞ –Ω–∏–∑–∫–∞—è

‚ùå Balance —Å–∏—Å—Ç–µ–º–∞
   ‚Üí Withdrawal complexity, –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ

‚ùå Leaderboard/Achievements/Challenges
   ‚Üí Gamification - –≤ Phase 2
```

**–ß—Ç–æ –∏–∑–º–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º:**
```
Metrics –¥–ª—è v1.0:
‚îú‚îÄ k-factor (avg referrals per user)
‚îú‚îÄ Referral activation rate
‚îú‚îÄ Referral ‚Üí PAID conversion rate
‚îú‚îÄ CAC —Å–Ω–∏–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ referrals
‚îî‚îÄ LTV referral users vs organic

–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
‚îú‚îÄ k-factor > 1.5 (viral growth)
‚îú‚îÄ Activation rate > 50%
‚îú‚îÄ Conversion rate > 10%
‚îî‚îÄ LTV ratio (referral/organic) > 1.2

‚úÖ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ metrics –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã ‚Üí –¥–æ–±–∞–≤–ª—è—Ç—å Tier —Å–∏—Å—Ç–µ–º—É
```

**–§–∞–∑–∞ 2: –î–æ–±–∞–≤–∏—Ç—å Tiers (—á–µ—Ä–µ–∑ 3-6 –º–µ—Å—è—Ü–µ–≤)**
```
–£—Å–ª–æ–≤–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞:
‚úÖ v1.0 metrics –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã
‚úÖ Fraud detection —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ CAC –∏ LTV –∏–∑–º–µ—Ä–µ–Ω—ã
‚úÖ Product Analytics –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å:
‚îú‚îÄ 2 tier'–∞ (–Ω–µ 4): Silver (5+) –∏ Gold (20+)
‚îú‚îÄ Monthly bonus (–±–µ–∑ revenue share –ø–æ–∫–∞)
‚îú‚îÄ Discounts –Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
‚îî‚îÄ Leaderboard –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (2 –Ω–µ–¥–µ–ª–∏ –≤–º–µ—Å—Ç–æ 2 –º–µ—Å—è—Ü–µ–≤)
‚úÖ –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫
‚úÖ –ò–∑–º–µ—Ä–∏–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
‚úÖ –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ
‚úÖ Data-driven —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
```

---

## ‚ö†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ú–ò–ù–£–°–´

### 1. Testing Coverage ‚≠ê‚≠ê

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

```bash
# –§–∞–π–ª—ã –≤ /tests:
tests/
‚îú‚îÄ‚îÄ test_coingecko_api.py
‚îú‚îÄ‚îÄ test_crypto_tools_fix.py
‚îî‚îÄ‚îÄ ... (25 —Ñ–∞–π–ª–æ–≤)

# –ö–æ–¥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
534,302 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

# –û—Ü–µ–Ω–æ—á–Ω—ã–π coverage: <30%
```

#### –ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

**1. Unit Tests**
```python
# –ù—É–∂–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è:

‚ùå Services (openai_service, coingecko_service, etc.)
   - Mock external API calls
   - Test error handling
   - Test retry logic

‚ùå CRUD operations (database/crud.py)
   - Test all database operations
   - Test transactions
   - Test constraints

‚ùå Middleware (all middleware/*.py)
   - Test request limiting
   - Test subscription checks
   - Test language detection

‚ùå Utils (coin_parser, vision_tokens, etc.)
   - Test edge cases
   - Test input validation
```

**2. Integration Tests**
```python
# –ù—É–∂–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è:

‚ùå API endpoints (FastAPI)
   - Test all routes
   - Test authentication
   - Test error responses

‚ùå Payment flow
   - Test invoice creation
   - Test payment processing
   - Test subscription activation

‚ùå Telegram handlers
   - Test all commands
   - Test callback queries
   - Test state machines
```

**3. E2E Tests**
```python
# –ù—É–∂–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è:

‚ùå User journeys
   - Registration ‚Üí First request ‚Üí Limit hit ‚Üí Purchase
   - Referral flow
   - Subscription renewal

‚ùå Mini App flow
   - Authentication
   - Chat interaction
   - Payment in Mini App
```

**4. Performance Tests**
```python
# –ù—É–∂–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è:

‚ùå Load testing
   - 100 concurrent users
   - 1000 requests/minute
   - Database connection pool stress

‚ùå API response times
   - /price endpoint < 500ms
   - /analyze endpoint < 2s
   - Payment endpoints < 1s
```

#### üî• –î–ï–ô–°–¢–í–ò–Ø:

**–î–µ–π—Å—Ç–≤–∏–µ #1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å pytest –ø—Ä–∞–≤–∏–ª—å–Ω–æ**

```python
# pytest.ini (–æ–±–Ω–æ–≤–∏—Ç—å)
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    --verbose
    --strict-markers
    --cov=src
    --cov-report=html
    --cov-report=term-missing
    --cov-fail-under=70

# –¶–µ–ª—å: 70% coverage
```

**–î–µ–π—Å—Ç–≤–∏–µ #2: –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã**

```python
# tests/unit/test_openai_service.py
import pytest
from unittest.mock import AsyncMock, patch
from src.services.openai_service import OpenAIService

@pytest.mark.asyncio
async def test_model_routing_free_tier():
    """FREE tier –¥–æ–ª–∂–µ–Ω –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞—Ç—å gpt-4o-mini"""
    service = OpenAIService(api_key="test")

    messages = [{"role": "user", "content": "test" * 1000}]
    model = service._select_model(messages, user_tier="free")

    assert model == "gpt-4o-mini"

@pytest.mark.asyncio
async def test_model_routing_premium_tier():
    """PREMIUM tier –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ—É—Ç–∏–Ω–≥ –ø–æ —Ç–æ–∫–µ–Ω–∞–º"""
    service = OpenAIService(api_key="test")

    # –ö–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç ‚Üí mini
    short_messages = [{"role": "user", "content": "test"}]
    assert service._select_model(short_messages, "premium") == "gpt-4o-mini"

    # –î–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚Üí gpt-4o
    long_messages = [{"role": "user", "content": "test" * 1000}]
    assert service._select_model(long_messages, "premium") == "gpt-4o"

@pytest.mark.asyncio
async def test_token_limits_enforced():
    """Token limits –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –ø–æ tier"""
    service = OpenAIService(api_key="test")

    with patch.object(service.client.chat.completions, 'create') as mock_create:
        await service.get_completion(
            messages=[{"role": "user", "content": "test"}],
            user_tier="free"
        )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ max_tokens —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        call_args = mock_create.call_args
        assert call_args.kwargs['max_tokens'] == 500  # FREE limit
```

```python
# tests/integration/test_payment_api.py
import pytest
from httpx import AsyncClient
from src.api.auth import validate_telegram_init_data

@pytest.mark.asyncio
async def test_create_stars_invoice_success(client: AsyncClient, test_user):
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è Telegram Stars invoice"""

    # Mock Telegram initData
    init_data = generate_test_init_data(test_user)

    response = await client.post(
        "/api/payment/stars/create-invoice",
        headers={"Authorization": f"tma {init_data}"},
        json={
            "tier": "premium",
            "duration_months": 1
        }
    )

    assert response.status_code == 200
    data = response.json()

    assert data["success"] is True
    assert data["data"]["tier"] == "premium"
    assert data["data"]["price_stars"] == 2499

@pytest.mark.asyncio
async def test_create_invoice_invalid_tier(client: AsyncClient, test_user):
    """–¢–µ—Å—Ç —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º tier"""

    init_data = generate_test_init_data(test_user)

    response = await client.post(
        "/api/payment/stars/create-invoice",
        headers={"Authorization": f"tma {init_data}"},
        json={
            "tier": "invalid",
            "duration_months": 1
        }
    )

    assert response.status_code == 400
```

**–î–µ–π—Å—Ç–≤–∏–µ #3: CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**

```yaml
# .github/workflows/tests.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: syntra_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run tests
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost/syntra_test
        run: |
          pytest --cov=src --cov-fail-under=70

      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Coverage > 70%
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π PR
‚úÖ Confidence –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
‚úÖ –ú–µ–Ω—å—à–µ production bugs
```

---

### 2. Monitoring & Observability ‚≠ê‚≠ê

#### –ß—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å:

```python
‚úÖ Sentry –¥–ª—è –æ—à–∏–±–æ–∫ (config/sentry.py)
‚úÖ Loguru –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (config/logging.py)
‚úÖ Cost tracking –≤ –ë–î (cost_tracking —Ç–∞–±–ª–∏—Ü–∞)
```

#### –ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

**1. APM (Application Performance Monitoring)**
```
‚ùå –ù–µ—Ç —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
‚ùå –ù–µ –≤–∏–¥–Ω–æ bottlenecks
‚ùå –ù–µ –≤–∏–¥–Ω–æ slow queries
‚ùå –ù–µ –≤–∏–¥–Ω–æ external API latency
```

**2. Metrics**
```
‚ùå –ù–µ—Ç Prometheus metrics
‚ùå –ù–µ—Ç Grafana dashboards
‚ùå –ù–µ—Ç alerting
```

**3. Distributed Tracing**
```
‚ùå –ù–µ –≤–∏–¥–Ω–æ full request path:
   Telegram ‚Üí Bot ‚Üí Service ‚Üí External API ‚Üí DB ‚Üí Response
```

#### üî• –î–ï–ô–°–¢–í–ò–Ø:

**–î–µ–π—Å—Ç–≤–∏–µ #1: –î–æ–±–∞–≤–∏—Ç—å Prometheus metrics**

```python
# requirements.txt
prometheus-client==0.19.0

# src/utils/metrics.py
from prometheus_client import Counter, Histogram, Gauge, generate_latest
from prometheus_client import CONTENT_TYPE_LATEST

# Counters
requests_total = Counter(
    'syntra_requests_total',
    'Total requests',
    ['command', 'tier', 'status']
)

ai_requests_total = Counter(
    'syntra_ai_requests_total',
    'Total AI requests',
    ['model', 'tier']
)

payments_total = Counter(
    'syntra_payments_total',
    'Total payments',
    ['tier', 'provider', 'status']
)

# Histograms (–¥–ª—è latency)
request_duration = Histogram(
    'syntra_request_duration_seconds',
    'Request duration',
    ['endpoint', 'method']
)

ai_request_duration = Histogram(
    'syntra_ai_request_duration_seconds',
    'AI request duration',
    ['model']
)

# Gauges (–¥–ª—è current state)
active_users = Gauge(
    'syntra_active_users',
    'Active users in last 24h'
)

free_users = Gauge(
    'syntra_free_users',
    'Total FREE tier users'
)

paid_users = Gauge(
    'syntra_paid_users',
    'Total PAID tier users'
)

mrr = Gauge(
    'syntra_mrr_usd',
    'Monthly Recurring Revenue in USD'
)
```

```python
# api_server.py
from src.utils.metrics import generate_latest, CONTENT_TYPE_LATEST

@app.get("/metrics")
async def metrics():
    """Prometheus metrics endpoint"""
    return Response(
        content=generate_latest(),
        media_type=CONTENT_TYPE_LATEST
    )
```

**–î–µ–π—Å—Ç–≤–∏–µ #2: Instrument –∫–æ–¥**

```python
# src/bot/handlers/chat.py
from src.utils.metrics import requests_total, request_duration
import time

@router.message(F.text)
async def handle_message(message: Message, user: User):
    start_time = time.time()

    try:
        # ... existing code ...

        # Track success
        requests_total.labels(
            command="chat",
            tier=user.subscription.tier,
            status="success"
        ).inc()

    except Exception as e:
        # Track error
        requests_total.labels(
            command="chat",
            tier=user.subscription.tier,
            status="error"
        ).inc()
        raise

    finally:
        # Track duration
        duration = time.time() - start_time
        request_duration.labels(
            endpoint="chat",
            method="message"
        ).observe(duration)
```

**–î–µ–π—Å—Ç–≤–∏–µ #3: Grafana dashboard**

```yaml
# docker-compose.yml (–¥–æ–±–∞–≤–∏—Ç—å)
services:
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin

volumes:
  prometheus_data:
  grafana_data:
```

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'syntra_bot'
    static_configs:
      - targets: ['bot:8000']  # Bot metrics

  - job_name: 'syntra_api'
    static_configs:
      - targets: ['api:8003']  # API metrics
```

**Grafana Dashboard –∫–æ–Ω—Ñ–∏–≥:**
```json
{
  "dashboard": {
    "title": "Syntra Metrics",
    "panels": [
      {
        "title": "Requests per Second",
        "targets": [{
          "expr": "rate(syntra_requests_total[5m])"
        }]
      },
      {
        "title": "AI Request Latency (p95)",
        "targets": [{
          "expr": "histogram_quantile(0.95, syntra_ai_request_duration_seconds)"
        }]
      },
      {
        "title": "Error Rate",
        "targets": [{
          "expr": "rate(syntra_requests_total{status=\"error\"}[5m])"
        }]
      },
      {
        "title": "MRR",
        "targets": [{
          "expr": "syntra_mrr_usd"
        }]
      }
    ]
  }
}
```

**–î–µ–π—Å—Ç–≤–∏–µ #4: Alerting**

```yaml
# prometheus/alerts.yml
groups:
  - name: syntra_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(syntra_requests_total{status="error"}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors/sec"

      - alert: SlowAIRequests
        expr: histogram_quantile(0.95, syntra_ai_request_duration_seconds) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "AI requests are slow"
          description: "p95 latency is {{ $value }} seconds"

      - alert: MRRDrop
        expr: delta(syntra_mrr_usd[1h]) < -100
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "MRR dropped significantly"
          description: "MRR dropped by ${{ $value }}"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Real-time visibility –≤ production
‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
‚úÖ Data-driven –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
‚úÖ SLA monitoring
```

---

### 3. Database Optimization ‚≠ê‚≠ê‚≠ê

#### –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

**1. –¢–∞–±–ª–∏—Ü—ã –±–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
```sql
-- –¢–∞–±–ª–∏—Ü—ã –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—Ä–∞—Å—Ç—É—Ç –û–ì–†–û–ú–ù–´–ú–ò:

chat_history:
‚îú‚îÄ 1000 users √ó 50 messages/user = 50,000 —Å—Ç—Ä–æ–∫
‚îú‚îÄ 10,000 users √ó 50 messages = 500,000 —Å—Ç—Ä–æ–∫
‚îî‚îÄ 100,000 users √ó 50 messages = 5,000,000 —Å—Ç—Ä–æ–∫! üö®

cost_tracking:
‚îú‚îÄ 1000 users √ó 30 requests/day √ó 30 days = 900,000 —Å—Ç—Ä–æ–∫/–º–µ—Å
‚îî‚îÄ –ó–∞ –≥–æ–¥ = 10,800,000 —Å—Ç—Ä–æ–∫! üö®

request_limits:
‚îú‚îÄ 1000 users √ó 365 –¥–Ω–µ–π = 365,000 —Å—Ç—Ä–æ–∫/–≥–æ–¥
‚îî‚îÄ –ù—É–∂–Ω–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

**2. Connection pooling –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π**
```python
# src/database/engine.py
engine = create_async_engine(
    DATABASE_URL,
    # ‚ö†Ô∏è –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
    pool_size=20,      # –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–∞–ª–æ
    max_overflow=40,   # –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–∞–ª–æ
    # –ù–µ—Ç pool timeout
    # –ù–µ—Ç pool recycle
)
```

**3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏**
```
‚ùå –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
‚ùå –ù–µ—Ç cold storage –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
‚ùå Backups –∑–∞–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞
```

#### üî• –î–ï–ô–°–¢–í–ò–Ø:

**–î–µ–π—Å—Ç–≤–∏–µ #1: –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü**

```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å chat_history –ø–æ –¥–∞—Ç–µ

-- 1. –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE chat_history_new (
    id SERIAL,
    user_id INTEGER NOT NULL,
    role VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    tokens_used INTEGER,
    model VARCHAR(100),
    PRIMARY KEY (id, timestamp)
) PARTITION BY RANGE (timestamp);

-- 2. –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏ (–ø–æ –º–µ—Å—è—Ü–∞–º)
CREATE TABLE chat_history_2025_01 PARTITION OF chat_history_new
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE chat_history_2025_02 PARTITION OF chat_history_new
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

-- 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (pg_partman extension)
CREATE EXTENSION pg_partman;

SELECT create_parent(
    'public.chat_history_new',
    'timestamp',
    'native',
    'monthly'
);

-- 4. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
INSERT INTO chat_history_new
SELECT * FROM chat_history;

-- 5. Rename tables (–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
BEGIN;
ALTER TABLE chat_history RENAME TO chat_history_old;
ALTER TABLE chat_history_new RENAME TO chat_history;
COMMIT;

-- 6. Drop old table –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
DROP TABLE chat_history_old;
```

```sql
-- –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è cost_tracking
CREATE TABLE cost_tracking_new (
    id SERIAL,
    user_id INTEGER NOT NULL,
    service VARCHAR(50) NOT NULL,
    model VARCHAR(100),
    tokens INTEGER NOT NULL,
    cost FLOAT NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    request_type VARCHAR(100),
    PRIMARY KEY (id, timestamp)
) PARTITION BY RANGE (timestamp);

-- –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏
SELECT create_parent(
    'public.cost_tracking_new',
    'timestamp',
    'native',
    'monthly'
);
```

**–î–µ–π—Å—Ç–≤–∏–µ #2: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å connection pool**

```python
# src/database/engine.py
from sqlalchemy.pool import QueuePool

engine = create_async_engine(
    DATABASE_URL,

    # Connection pool settings
    poolclass=QueuePool,
    pool_size=50,        # –£–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è production
    max_overflow=100,    # Burst capacity
    pool_timeout=30,     # Wait max 30s for connection
    pool_recycle=3600,   # Recycle connections every hour
    pool_pre_ping=True,  # Test connection before use

    # Performance settings
    echo=False,          # Disable SQL logging in prod

    # PostgreSQL specific
    connect_args={
        "server_settings": {
            "application_name": "syntra_bot",
            "jit": "off",  # Disable JIT for faster simple queries
        }
    }
)

# Monitoring pool health
from sqlalchemy import event

@event.listens_for(engine.sync_engine, "connect")
def receive_connect(dbapi_conn, connection_record):
    """Track connections"""
    from src.utils.metrics import db_connections
    db_connections.inc()

@event.listens_for(engine.sync_engine, "close")
def receive_close(dbapi_conn, connection_record):
    """Track disconnections"""
    from src.utils.metrics import db_connections
    db_connections.dec()
```

**–î–µ–π—Å—Ç–≤–∏–µ #3: –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

```python
# src/tasks/archive_old_data.py
from datetime import datetime, timedelta
from sqlalchemy import delete
from src.database.engine import get_session
from src.database.models import ChatHistory, CostTracking, RequestLimit

async def archive_old_chat_history():
    """
    Archive chat history older than 90 days
    """
    cutoff_date = datetime.utcnow() - timedelta(days=90)

    async with get_session() as session:
        # Export to S3/file before deletion
        old_messages = await session.execute(
            select(ChatHistory).where(ChatHistory.timestamp < cutoff_date)
        )

        # TODO: Export to S3
        # await export_to_s3(old_messages)

        # Delete from main table
        await session.execute(
            delete(ChatHistory).where(ChatHistory.timestamp < cutoff_date)
        )

        await session.commit()

        logger.info(f"Archived chat history older than {cutoff_date}")

async def archive_old_cost_tracking():
    """
    Archive cost tracking older than 1 year
    """
    cutoff_date = datetime.utcnow() - timedelta(days=365)

    async with get_session() as session:
        # Keep aggregated data, delete raw
        # TODO: Aggregate before deletion

        await session.execute(
            delete(CostTracking).where(CostTracking.timestamp < cutoff_date)
        )

        await session.commit()

async def cleanup_old_request_limits():
    """
    Delete request_limits older than 30 days
    """
    cutoff_date = date.today() - timedelta(days=30)

    async with get_session() as session:
        await session.execute(
            delete(RequestLimit).where(RequestLimit.date < cutoff_date)
        )

        await session.commit()
```

```python
# bot.py (–¥–æ–±–∞–≤–∏—Ç—å –≤ startup)
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from src.tasks.archive_old_data import (
    archive_old_chat_history,
    archive_old_cost_tracking,
    cleanup_old_request_limits
)

scheduler = AsyncIOScheduler()

# Run daily at 3 AM
scheduler.add_job(
    archive_old_chat_history,
    'cron',
    hour=3,
    minute=0
)

scheduler.add_job(
    archive_old_cost_tracking,
    'cron',
    hour=3,
    minute=30
)

scheduler.add_job(
    cleanup_old_request_limits,
    'cron',
    hour=4,
    minute=0
)

scheduler.start()
```

**–î–µ–π—Å—Ç–≤–∏–µ #4: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**

```sql
-- Analyze slow queries
-- 1. Enable pg_stat_statements extension
CREATE EXTENSION pg_stat_statements;

-- 2. –ù–∞–π—Ç–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
SELECT
    query,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
-- –ù–∞–ø—Ä–∏–º–µ—Ä:

-- Composite index –¥–ª—è —á–∞—Å—Ç–æ–≥–æ join
CREATE INDEX idx_chat_history_user_timestamp
ON chat_history(user_id, timestamp DESC);

-- Index –¥–ª—è filtering –ø–æ tier
CREATE INDEX idx_subscriptions_tier_active
ON subscriptions(tier, is_active)
WHERE is_active = true;

-- Partial index –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
CREATE INDEX idx_subscriptions_expiring
ON subscriptions(expires_at)
WHERE is_active = true AND expires_at IS NOT NULL;

-- Index –¥–ª—è referral stats
CREATE INDEX idx_referrals_referrer_status
ON referrals(referrer_id, status);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Queries –æ—Å—Ç–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä—ã–º–∏ –ø—Ä–∏ —Ä–æ—Å—Ç–µ
‚úÖ –ú–µ–Ω—å—à–µ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
‚úÖ –ë—ã—Å—Ç—Ä–µ–µ backups
‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ users
```

---

### 4. Frontend Architecture ‚≠ê‚≠ê‚≠ê

#### –ß—Ç–æ —Ö–æ—Ä–æ—à–æ:

```typescript
‚úÖ Next.js 16 (App Router)
‚úÖ React 19 (Concurrent features)
‚úÖ TypeScript
‚úÖ TailwindCSS 4
‚úÖ Zustand –¥–ª—è state
‚úÖ SWR –¥–ª—è data fetching
‚úÖ Framer Motion –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
```

#### –ü—Ä–æ–±–ª–µ–º—ã:

**1. Error Boundaries –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç**
```typescript
// ‚ùå –ï—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç crash–Ω–µ—Ç, –≤—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ª–æ–º–∞–µ—Ç—Å—è
// ‚úÖ –ù—É–∂–Ω—ã Error Boundaries –¥–ª—è graceful degradation
```

**2. Offline support –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç**
```typescript
// ‚ùå –ù–µ—Ç Service Worker
// ‚ùå –ù–µ—Ç cache –¥–ª—è offline —Ä–∞–±–æ—Ç—ã
// ‚ùå –ù–µ—Ç PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
```

**3. Loading states –Ω–µ–ø–æ–ª–Ω—ã–µ**
```typescript
// ‚ö†Ô∏è –ù–µ –≤–µ–∑–¥–µ skeleton screens
// ‚ö†Ô∏è Spinner vs Skeleton inconsistency
```

**4. API client –±–∞–∑–æ–≤—ã–π**
```typescript
// frontend/shared/api/client.ts

// ‚ùå –ù–µ—Ç retry logic
// ‚ùå –ù–µ—Ç request deduplication
// ‚ùå –ù–µ—Ç automatic refresh —Ç–æ–∫–µ–Ω–æ–≤
```

#### üî• –î–ï–ô–°–¢–í–ò–Ø:

**–î–µ–π—Å—Ç–≤–∏–µ #1: –î–æ–±–∞–≤–∏—Ç—å Error Boundaries**

```typescript
// frontend/components/errors/ErrorBoundary.tsx
'use client';

import { Component, ReactNode } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: any) {
    // Log to Sentry
    console.error('Error caught by boundary:', error, errorInfo);

    // TODO: Send to Sentry
    // Sentry.captureException(error, { extra: errorInfo });
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="min-h-screen bg-black flex items-center justify-center p-4">
          <div className="glassmorphism-card rounded-2xl p-6 max-w-md">
            <div className="text-red-400 text-4xl mb-4">‚ö†Ô∏è</div>
            <h2 className="text-white font-bold text-xl mb-2">
              –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
            </h2>
            <p className="text-gray-400 text-sm mb-4">
              {this.state.error?.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}
            </p>
            <button
              onClick={() => window.location.reload()}
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
            >
              –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
```

```typescript
// frontend/app/layout.tsx (–æ–±–µ—Ä–Ω—É—Ç—å –≤ ErrorBoundary)
import { ErrorBoundary } from '@/components/errors/ErrorBoundary';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <ErrorBoundary>
          <TelegramProvider>
            {children}
          </TelegramProvider>
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

**–î–µ–π—Å—Ç–≤–∏–µ #2: PWA Support**

```typescript
// next.config.js
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
});

module.exports = withPWA({
  // ... existing config
});
```

```json
// public/manifest.json
{
  "name": "Syntra Trade Consultant",
  "short_name": "Syntra",
  "description": "AI-powered crypto trading consultant",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#3B82F6",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

**–î–µ–π—Å—Ç–≤–∏–µ #3: –£–ª—É—á—à–∏—Ç—å API client**

```typescript
// frontend/shared/api/client.ts
import axios, { AxiosError, AxiosRequestConfig } from 'axios';

const MAX_RETRIES = 3;
const RETRY_DELAY = 1000;

// Request deduplication cache
const pendingRequests = new Map<string, Promise<any>>();

function getRequestKey(config: AxiosRequestConfig): string {
  return `${config.method}:${config.url}:${JSON.stringify(config.params)}`;
}

const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  timeout: 10000,
});

// Request interceptor (add auth)
apiClient.interceptors.request.use((config) => {
  const initData = localStorage.getItem('tg_init_data');
  if (initData) {
    config.headers.Authorization = `tma ${initData}`;
  }
  return config;
});

// Response interceptor (retry + deduplication)
apiClient.interceptors.response.use(
  (response) => response,
  async (error: AxiosError) => {
    const config = error.config as AxiosRequestConfig & { _retry?: number };

    // Retry logic
    if (!config || !config._retry) {
      config._retry = 0;
    }

    if (config._retry < MAX_RETRIES) {
      config._retry++;

      // Exponential backoff
      const delay = RETRY_DELAY * Math.pow(2, config._retry - 1);
      await new Promise(resolve => setTimeout(resolve, delay));

      return apiClient(config);
    }

    throw error;
  }
);

// Deduplicated request wrapper
async function deduplicatedRequest<T>(
  config: AxiosRequestConfig
): Promise<T> {
  const key = getRequestKey(config);

  // Check if same request is pending
  if (pendingRequests.has(key)) {
    return pendingRequests.get(key)!;
  }

  // Make request
  const promise = apiClient(config).then(res => res.data);

  // Cache promise
  pendingRequests.set(key, promise);

  // Cleanup after completion
  promise.finally(() => {
    pendingRequests.delete(key);
  });

  return promise;
}

export const api = {
  get: <T>(url: string, config?: AxiosRequestConfig) =>
    deduplicatedRequest<T>({ ...config, method: 'GET', url }),

  post: <T>(url: string, data?: any, config?: AxiosRequestConfig) =>
    apiClient.post<T>(url, data, config).then(res => res.data),

  put: <T>(url: string, data?: any, config?: AxiosRequestConfig) =>
    apiClient.put<T>(url, data, config).then(res => res.data),

  delete: <T>(url: string, config?: AxiosRequestConfig) =>
    apiClient.delete<T>(url, config).then(res => res.data),
};
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Graceful error handling
‚úÖ Offline capabilities
‚úÖ –ú–µ–Ω—å—à–µ duplicate requests
‚úÖ Better UX
```

---

### 5. Security ‚≠ê‚≠ê‚≠ê

#### –ß—Ç–æ —Ö–æ—Ä–æ—à–æ:

```python
‚úÖ HMAC –≤–∞–ª–∏–¥–∞—Ü–∏—è Telegram initData (SHA-256)
‚úÖ SQL injection protection (SQLAlchemy ORM)
‚úÖ Environment variables –¥–ª—è secrets
‚úÖ HTTPS enforcement
```

#### –ü—Ä–æ–±–ª–µ–º—ã:

**1. CORS —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–π**
```python
# api_server.py:49-62
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "http://127.0.0.1:3000",
        "https://*.vercel.app",  # ‚ö†Ô∏è –õ–Æ–ë–û–ô Vercel app!
        "https://*.ngrok-free.app",
        "https://*.ngrok.io",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**2. Rate limiting —Ç–æ–ª—å–∫–æ –Ω–∞ middleware**
```python
# ‚úÖ –ï—Å—Ç—å RequestLimitMiddleware –¥–ª—è Telegram –±–æ—Ç–∞
# ‚ùå –ù–ï–¢ rate limiting –¥–ª—è API endpoints
```

**3. RBAC –≤ –∫–æ–¥–µ**
```python
# ‚ùå Admin –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ hardcoded ADMIN_IDS
# ‚ùå –ù–µ—Ç role-based access control
# ‚ùå –ù–µ—Ç permission system
```

**4. –ù–µ—Ç input validation**
```python
# ‚ö†Ô∏è Pydantic models –µ—Å—Ç—å, –Ω–æ validation –Ω–µ–ø–æ–ª–Ω–∞—è
# ‚ö†Ô∏è –ù–µ—Ç sanitization –¥–ª—è user input
```

#### üî• –î–ï–ô–°–¢–í–ò–Ø:

**–î–µ–π—Å—Ç–≤–∏–µ #1: –£–∂–µ—Å—Ç–æ—á–∏—Ç—å CORS**

```python
# api_server.py
import os

ALLOWED_ORIGINS = os.getenv("ALLOWED_ORIGINS", "").split(",")

# –î–ª—è production:
# ALLOWED_ORIGINS="https://syntra.app,https://app.syntra.com"

app.add_middleware(
    CORSMiddleware,
    allow_origins=ALLOWED_ORIGINS if ALLOWED_ORIGINS else [
        "http://localhost:3000",  # Dev —Ç–æ–ª—å–∫–æ
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],  # –ù–µ "*"
    allow_headers=["Content-Type", "Authorization"],  # –ù–µ "*"
    max_age=3600,  # Cache preflight
)
```

**–î–µ–π—Å—Ç–≤–∏–µ #2: Rate limiting –¥–ª—è API**

```python
# requirements.txt
slowapi==0.1.9

# src/api/rate_limit.py
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(
    key_func=get_remote_address,
    default_limits=["100/hour"]
)

# api_server.py
from src.api.rate_limit import limiter, RateLimitExceeded, _rate_limit_exceeded_handler

app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ endpoints:
from slowapi import Limiter
from src.api.rate_limit import limiter

@router.post("/chat/send")
@limiter.limit("10/minute")  # Max 10 AI requests per minute
async def send_chat_message(
    request: Request,
    message: ChatMessageRequest,
    user: User = Depends(get_current_user)
):
    ...

@router.post("/payment/stars/create-invoice")
@limiter.limit("5/minute")  # Max 5 payment attempts per minute
async def create_stars_invoice(
    request: Request,
    ...
):
    ...
```

**–î–µ–π—Å—Ç–≤–∏–µ #3: RBAC —Å–∏—Å—Ç–µ–º–∞**

```python
# src/database/models.py (–¥–æ–±–∞–≤–∏—Ç—å)
from enum import Enum

class UserRole(str, Enum):
    USER = "user"
    ADMIN = "admin"
    MODERATOR = "moderator"

class Permission(str, Enum):
    # User permissions
    CREATE_CHAT = "create_chat"
    VIEW_PROFILE = "view_profile"

    # Admin permissions
    VIEW_USERS = "view_users"
    EDIT_USERS = "edit_users"
    VIEW_PAYMENTS = "view_payments"
    VIEW_STATS = "view_stats"

    # Moderator permissions
    BAN_USERS = "ban_users"
    VIEW_REPORTS = "view_reports"

ROLE_PERMISSIONS = {
    UserRole.USER: [
        Permission.CREATE_CHAT,
        Permission.VIEW_PROFILE,
    ],
    UserRole.MODERATOR: [
        Permission.CREATE_CHAT,
        Permission.VIEW_PROFILE,
        Permission.BAN_USERS,
        Permission.VIEW_REPORTS,
    ],
    UserRole.ADMIN: [
        # All permissions
        *Permission.__members__.values()
    ],
}

# Update User model
class User(Base):
    # ... existing fields ...

    role: Mapped[str] = mapped_column(
        String(20),
        default=UserRole.USER.value,
        nullable=False,
    )

    def has_permission(self, permission: Permission) -> bool:
        """Check if user has permission"""
        user_role = UserRole(self.role)
        return permission in ROLE_PERMISSIONS.get(user_role, [])
```

```python
# src/api/permissions.py
from fastapi import HTTPException
from src.database.models import User, Permission

def require_permission(permission: Permission):
    """Decorator –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ permissions"""
    def decorator(func):
        async def wrapper(*args, user: User, **kwargs):
            if not user.has_permission(permission):
                raise HTTPException(
                    status_code=403,
                    detail=f"Permission denied: {permission.value}"
                )
            return await func(*args, user=user, **kwargs)
        return wrapper
    return decorator

# Usage:
@router.get("/admin/users")
@require_permission(Permission.VIEW_USERS)
async def get_users(user: User = Depends(get_current_user)):
    ...
```

**–î–µ–π—Å—Ç–≤–∏–µ #4: Input validation & sanitization**

```python
# src/api/validators.py
from pydantic import BaseModel, validator, Field
from typing import Optional
import re

class ChatMessageRequest(BaseModel):
    message: str = Field(..., min_length=1, max_length=4000)

    @validator('message')
    def sanitize_message(cls, v):
        # Remove control characters
        v = re.sub(r'[\x00-\x1F\x7F-\x9F]', '', v)

        # Strip excessive whitespace
        v = ' '.join(v.split())

        return v.strip()

class CoinIdRequest(BaseModel):
    coin_id: str = Field(..., min_length=1, max_length=50)

    @validator('coin_id')
    def validate_coin_id(cls, v):
        # Only alphanumeric and dashes
        if not re.match(r'^[a-z0-9-]+$', v):
            raise ValueError('Invalid coin ID format')
        return v.lower()
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF attacks
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç rate limit abuse
‚úÖ Proper authorization
‚úÖ Input validation
‚úÖ Security hardening
```

---

## üöÄ ACTION PLAN (Roadmap)

### üî• –§–∞–∑–∞ 1: Fix Economics & Analytics (–ù–µ–¥–µ–ª–∏ 1-2) - –ö–†–ò–¢–ò–ß–ù–û

**–¶–µ–ª—å:** –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ –¥–µ–Ω–µ–≥ –∏ –Ω–∞—á–∞—Ç—å –∏–∑–º–µ—Ä—è—Ç—å –º–µ—Ç—Ä–∏–∫–∏

| –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
|--------|-----------|-------|---------------|
| –°–Ω–∏–∑–∏—Ç—å FREE tier: 5‚Üí3 –∑–∞–ø—Ä–æ—Å–∞ | P0 | 2 —á–∞—Å–∞ | Backend |
| –ñ–µ—Å—Ç–∫–∏–π —Ä–æ—É—Ç–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π –ø–æ tier | P0 | 4 —á–∞—Å–∞ | Backend |
| –î–æ–±–∞–≤–∏—Ç—å token limits –ø–æ tier | P0 | 4 —á–∞—Å–∞ | Backend |
| –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostHog | P0 | 1 –¥–µ–Ω—å | Backend + Frontend |
| –î–æ–±–∞–≤–∏—Ç—å event tracking (10+ —Å–æ–±—ã—Ç–∏–π) | P0 | 2 –¥–Ω—è | Backend + Frontend |
| –°–æ–∑–¥–∞—Ç—å dashboards (5 –æ—Å–Ω–æ–≤–Ω—ã—Ö) | P0 | 1 –¥–µ–Ω—å | Analytics |
| Fix payment flow (1-step invoice) | P0 | 1 –¥–µ–Ω—å | Backend |
| **–ò–¢–û–ì–û** | | **~1.5 –Ω–µ–¥–µ–ª–∏** | |

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
‚úÖ FREE tier —É–±—ã—Ç–æ–∫ —Å–æ–∫—Ä–∞—â–µ–Ω –Ω–∞ 70% ($0.83 ‚Üí $0.25/–º–µ—Å)
‚úÖ –í–∏–¥–∏–º–æ—Å—Ç—å –≤ conversion funnel
‚úÖ –í–∏–¥–∏–º–æ—Å—Ç—å –≤ retention metrics
‚úÖ Payment conversion +30%
```

**KPIs –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
```
–ò–∑–º–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ 2 –Ω–µ–¥–µ–ª—å:
‚îú‚îÄ FREE ‚Üí PAID conversion rate (—Ü–µ–ª—å: >5%)
‚îú‚îÄ D7 retention (—Ü–µ–ª—å: >20%)
‚îú‚îÄ Payment completion rate (—Ü–µ–ª—å: >60%)
‚îî‚îÄ CAC —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
```

---

### ‚ö° –§–∞–∑–∞ 2: Optimize & Secure (–ù–µ–¥–µ–ª–∏ 3-4)

**–¶–µ–ª—å:** –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è |
|--------|-----------|-------|
| –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–æ MVP | P1 | 2 –¥–Ω—è |
| –î–æ–±–∞–≤–∏—Ç—å Prometheus metrics | P1 | 2 –¥–Ω—è |
| –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana dashboards | P1 | 1 –¥–µ–Ω—å |
| –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å chat_history | P1 | 1 –¥–µ–Ω—å |
| –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å connection pool | P1 | 4 —á–∞—Å–∞ |
| –£–∂–µ—Å—Ç–æ—á–∏—Ç—å CORS | P1 | 2 —á–∞—Å–∞ |
| –î–æ–±–∞–≤–∏—Ç—å API rate limiting | P1 | 1 –¥–µ–Ω—å |
| –î–æ–±–∞–≤–∏—Ç—å Error Boundaries (Frontend) | P2 | 1 –¥–µ–Ω—å |
| PWA support | P2 | 2 –¥–Ω—è |
| **–ò–¢–û–ì–û** | | **~2 –Ω–µ–¥–µ–ª–∏** |

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
‚úÖ Referral program –ø—Ä–æ—â–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ
‚úÖ Real-time monitoring —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ Database –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è
‚úÖ Security hardened
‚úÖ Better UX
```

---

### üìà –§–∞–∑–∞ 3: Growth & Testing (–ù–µ–¥–µ–ª–∏ 5-6)

**–¶–µ–ª—å:** –£–≤–µ–ª–∏—á–∏—Ç—å conversion –∏ retention

| –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è |
|--------|-----------|-------|
| A/B test: FREE tier (2 vs 3 –∑–∞–ø—Ä–æ—Å–∞) | P1 | 1 –Ω–µ–¥–µ–ª—è |
| A/B test: Pricing ($4.99 vs $5.99 BASIC) | P1 | 1 –Ω–µ–¥–µ–ª—è |
| Optimize onboarding flow | P1 | 3 –¥–Ω—è |
| Add social proof (testimonials) | P2 | 2 –¥–Ω—è |
| Improve retention messages | P1 | 2 –¥–Ω—è |
| –£–≤–µ–ª–∏—á–∏—Ç—å test coverage –¥–æ 70% | P2 | 1 –Ω–µ–¥–µ–ª—è |
| E2E —Ç–µ—Å—Ç—ã (critical paths) | P2 | 3 –¥–Ω—è |
| **–ò–¢–û–ì–û** | | **~2 –Ω–µ–¥–µ–ª–∏** |

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
‚úÖ Data-driven pricing optimization
‚úÖ Conversion rate —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
‚úÖ Retention improvement
‚úÖ Code quality up
```

---

### üöÄ –§–∞–∑–∞ 4: Scale (–ù–µ–¥–µ–ª–∏ 7-8+)

**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

| –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è |
|--------|-----------|-------|
| Webhooks –≤–º–µ—Å—Ç–æ polling | P1 | 1 –Ω–µ–¥–µ–ª—è |
| Redis –¥–ª—è caching | P1 | 3 –¥–Ω—è |
| Load testing (10K users) | P1 | 2 –¥–Ω—è |
| CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏ | P2 | 1 –¥–µ–Ω—å |
| Database read replicas | P2 | 2 –¥–Ω—è |
| Horizontal scaling setup | P1 | 1 –Ω–µ–¥–µ–ª—è |
| **–ò–¢–û–ì–û** | | **~2-3 –Ω–µ–¥–µ–ª–∏** |

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ 10K+ concurrent users
‚úÖ 99.9% uptime
‚úÖ Sub-second response times
‚úÖ Cost-efficient infrastructure
```

---

## üìä SUCCESS METRICS

### –≠—Ç–∞–ø 1 (–ú–µ—Å—è—Ü 1-2): Economics & Analytics

```
–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

üí∞ Economics:
‚îú‚îÄ FREE tier cost: $0.83 ‚Üí $0.25/–º–µ—Å (-70%)
‚îú‚îÄ FREE ‚Üí PAID conversion: >5%
‚îú‚îÄ CAC < $10
‚îî‚îÄ LTV:CAC ratio > 3

üìä Analytics:
‚îú‚îÄ PostHog deployed: ‚úÖ
‚îú‚îÄ 15+ events tracked: ‚úÖ
‚îú‚îÄ 5 dashboards created: ‚úÖ
‚îî‚îÄ Daily active monitoring: ‚úÖ

üí≥ Payments:
‚îú‚îÄ Payment completion rate: >60%
‚îú‚îÄ Payment latency: <2s
‚îî‚îÄ 1-step flow: ‚úÖ
```

### –≠—Ç–∞–ø 2 (–ú–µ—Å—è—Ü 3-4): Product-Market Fit

```
–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

üë• Users:
‚îú‚îÄ MAU growth: >20%/–º–µ—Å—è—Ü
‚îú‚îÄ D7 retention: >20%
‚îú‚îÄ D30 retention: >10%
‚îî‚îÄ Organic growth: >50% –æ—Ç traffic

üíµ Revenue:
‚îú‚îÄ MRR: >$1,000
‚îú‚îÄ ARPU: >$5
‚îú‚îÄ Churn rate: <5%/–º–µ—Å—è—Ü
‚îî‚îÄ Gross margin: >60%

üéØ Engagement:
‚îú‚îÄ Requests per user: >10/–Ω–µ–¥–µ–ª—è
‚îú‚îÄ Session length: >5 –º–∏–Ω—É—Ç
‚îî‚îÄ Feature adoption (Vision): >30%
```

### –≠—Ç–∞–ø 3 (–ú–µ—Å—è—Ü 5-6): Scale Ready

```
–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

üöÄ Scale:
‚îú‚îÄ Concurrent users: 1,000+
‚îú‚îÄ Response time (p95): <1s
‚îú‚îÄ Uptime: >99.9%
‚îî‚îÄ Error rate: <0.5%

üíª Tech:
‚îú‚îÄ Test coverage: >70%
‚îú‚îÄ Deploy frequency: Daily
‚îú‚îÄ Mean time to recovery: <1 hour
‚îî‚îÄ Database size: Optimized

üí∞ Unit Economics:
‚îú‚îÄ Gross margin: >70%
‚îú‚îÄ LTV:CAC: >5
‚îú‚îÄ Payback period: <3 months
‚îî‚îÄ Rule of 40: >40%
```

---

## ‚ùì FAQ

### Q: –ü–æ—á–µ–º—É FREE tier —É–±—ã—Ç–æ—á–µ–Ω —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?

**A:** –ü–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ —É–±—ã—Ç–∫–∏ —Ä–∞—Å—Ç—É—Ç –ª–∏–Ω–µ–π–Ω–æ:
```
1,000 FREE users = -$10,000/–≥–æ–¥
10,000 FREE users = -$100,000/–≥–æ–¥
100,000 FREE users = -$1,000,000/–≥–æ–¥

–ï—Å–ª–∏ conversion <10%, –≤—ã –Ω–µ –æ–∫—É–ø–∏—Ç–µ –∑–∞—Ç—Ä–∞—Ç—ã.
```

### Q: –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—ã?

**A:** –ú–æ–∂–Ω–æ, –Ω–æ —ç—Ç–æ –Ω–µ —Ä–µ—à–∏—Ç root cause:
- –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ —Ä–∞–≤–Ω–æ –≤—ã—Å–æ–∫–∞—è (66% –æ—Ç revenue)
- –ü–æ–≤—ã—à–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å–Ω–∏–∑–∏—Ç conversion
- Competitors –º–æ–≥—É—Ç –±—ã—Ç—å –¥–µ—à–µ–≤–ª–µ

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
1. –°–Ω–∏–∑–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
2. –ü–æ–≤—ã—Å–∏—Ç—å conversion (analytics + A/B tests)
3. –£–≤–µ–ª–∏—á–∏—Ç—å retention (better product)

### Q: –ó–∞—á–µ–º —É–ø—Ä–æ—â–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É?

**A:**
- Fraud risk —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π –±–µ–∑ IP tracking
- Revenue share —Å—ä–µ—Å—Ç –º–∞—Ä–∂—É (19% –∏—Ç–æ–≥–æ)
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç adoption
- –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–õ—É—á—à–µ:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –≤–µ—Ä—Å–∏—é
2. –ò–∑–º–µ—Ä–∏—Ç—å metrics (k-factor, conversion)
3. –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ —É–ª—É—á—à–∞—Ç—å

### Q: –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º?

**A:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Ç—Ä–∏—Ü—É Impact vs Effort:

```
High Impact, Low Effort (DO FIRST):
‚îú‚îÄ –°–Ω–∏–∑–∏—Ç—å FREE tier
‚îú‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostHog
‚îú‚îÄ Fix payment flow
‚îî‚îÄ –£–∂–µ—Å—Ç–æ—á–∏—Ç—å CORS

High Impact, High Effort (DO NEXT):
‚îú‚îÄ A/B testing infrastructure
‚îú‚îÄ Referral system simplification
‚îú‚îÄ Database partitioning
‚îî‚îÄ Test coverage increase

Low Impact, Low Effort (DO LATER):
‚îú‚îÄ PWA support
‚îú‚îÄ Error boundaries
‚îî‚îÄ Minor UI improvements

Low Impact, High Effort (DON'T DO):
‚îú‚îÄ Blockchain integration
‚îú‚îÄ Mobile native app
‚îî‚îÄ Custom AI model training
```

---

## üìö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

### A. Useful Links

**Analytics:**
- [PostHog Documentation](https://posthog.com/docs)
- [SaaS Metrics Guide](https://www.forentrepreneurs.com/saas-metrics-2/)
- [Retention Curve Analysis](https://andrewchen.com/retention-is-king/)

**Performance:**
- [PostgreSQL Partitioning](https://www.postgresql.org/docs/current/ddl-partitioning.html)
- [SQLAlchemy Performance](https://docs.sqlalchemy.org/en/20/faq/performance.html)
- [Next.js Performance](https://nextjs.org/docs/app/building-your-application/optimizing)

**Security:**
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [Telegram Bot Security](https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app)

---

### B. Code Snippets Repository

–í—Å–µ code snippets –∏–∑ —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –≤:
```
/docs/snippets/
‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îú‚îÄ‚îÄ posthog_setup.py
‚îÇ   ‚îú‚îÄ‚îÄ event_tracking.py
‚îÇ   ‚îî‚îÄ‚îÄ dashboards.json
‚îú‚îÄ‚îÄ optimization/
‚îÇ   ‚îú‚îÄ‚îÄ model_routing.py
‚îÇ   ‚îú‚îÄ‚îÄ token_limits.py
‚îÇ   ‚îî‚îÄ‚îÄ caching.py
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ partitioning.sql
‚îÇ   ‚îú‚îÄ‚îÄ connection_pool.py
‚îÇ   ‚îî‚îÄ‚îÄ archiving.py
‚îú‚îÄ‚îÄ security/
‚îÇ   ‚îú‚îÄ‚îÄ cors_config.py
‚îÇ   ‚îú‚îÄ‚îÄ rate_limiting.py
‚îÇ   ‚îî‚îÄ‚îÄ rbac.py
‚îî‚îÄ‚îÄ testing/
    ‚îú‚îÄ‚îÄ unit_tests.py
    ‚îú‚îÄ‚îÄ integration_tests.py
    ‚îî‚îÄ‚îÄ e2e_tests.py
```

---

## üìù CHANGELOG

| –î–∞—Ç–∞ | –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|--------|-----------|
| 2025-11-19 | 1.0 | –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ |

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** Claude Code (Sonnet 4.5)
**–î–∞—Ç–∞:** 2025-11-19
**–°—Ç–∞—Ç—É—Å:** üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ - —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—è

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

1. ‚úÖ –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –ø–æ–Ω—è—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
2. ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ (Impact √ó Effort)
3. ‚úÖ –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 (Economics & Analytics)
4. ‚úÖ –ò–∑–º–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
5. ‚úÖ –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ —É–ª—É—á—à–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

**–ü–æ–º–Ω–∏—Ç–µ:**
> "You can't improve what you don't measure"

–°–Ω–∞—á–∞–ª–∞ analytics, –ø–æ—Ç–æ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏! üöÄ
