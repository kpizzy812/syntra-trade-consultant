# CORS Fix - 2025-11-25

## Проблема
На продакшен-сервере (https://ai.syntratrade.xyz) фронтенд не мог обращаться к API из-за ошибок CORS.

## Причины
1. **API сервер не был запущен** - процесс на порту 8003 не работал
2. **Отсутствовал пакет `email-validator`** - API не мог запуститься из-за зависимости для валидации email (используется в Magic Link auth)
3. **Неправильный API URL в frontend** - `.env.production` содержал неверный URL

## Что было исправлено

### 1. Установлен недостающий пакет
```bash
pip install email-validator
```

Обновлен `requirements.txt`:
```
email-validator  # Email validation for pydantic EmailStr type (magic link auth)
```

### 2. Запущен API сервер на порту 8003
```bash
cd /root/syntraai
source .venv/bin/activate
nohup python api_server.py > logs/api_server.log 2>&1 &
```

Проверка:
```bash
curl http://localhost:8003/health
# → {"status":"ok","service":"Syntra Mini App API"}
```

### 3. Исправлен `.env.production` для фронтенда

**Было (неправильно):**
```
NEXT_PUBLIC_API_URL=http://localhost:8000
```

**Стало (правильно):**
```
NEXT_PUBLIC_API_URL=https://ai.syntratrade.xyz
```

**Важно:** Префикс `/api` НЕ нужен, т.к. он уже добавляется в коде `client.ts`.

### 4. Пересобран и перезапущен фронтенд
```bash
cd /root/syntraai/frontend
npm run build
NODE_ENV=production npm start -- -p 3003
```

## Архитектура
```
Браузер (https://ai.syntratrade.xyz)
    ↓
Nginx (порт 443)
    ├─ /api/* → Backend API (порт 8003)
    └─ /* → Next.js Frontend (порт 3003)
```

## CORS конфигурация
В `api_server.py` настроены разрешенные origins:
```python
allowed_origins = [
    "http://localhost:3000",  # Local development
    "http://127.0.0.1:3000",  # Alternative localhost
    "https://ai.syntratrade.xyz",  # Production domain
]
```

## Nginx конфигурация
```nginx
# API routes → FastAPI backend (порт 8003)
location /api/ {
    proxy_pass http://127.0.0.1:8003/;  # Слэш в конце убирает /api из пути
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## Проверка
1. API health check:
```bash
curl https://ai.syntratrade.xyz/api/health
# → {"status":"ok","service":"Syntra Mini App API"}
```

2. CORS headers:
```bash
curl -H "Origin: https://ai.syntratrade.xyz" https://ai.syntratrade.xyz/api/market/watchlist -v
# → access-control-allow-origin: https://ai.syntratrade.xyz
```

3. Pricing endpoint:
```bash
curl https://ai.syntratrade.xyz/api/config/pricing
# → {"tiers":[...],"trial":{...}}
```

## Результат
✅ API сервер запущен и отвечает на порту 8003
✅ CORS настроен правильно
✅ Фронтенд использует правильный API URL
✅ Nginx правильно проксирует запросы
✅ Все endpoints доступны и работают

## Файлы
- [api_server.py](/Users/a1/Projects/Syntra Trade Consultant/api_server.py) - FastAPI сервер
- [requirements.txt](/Users/a1/Projects/Syntra Trade Consultant/requirements.txt) - Python зависимости
- [frontend/.env.production](/Users/a1/Projects/Syntra Trade Consultant/frontend/.env.production) - Продакшен конфигурация фронтенда
- [frontend/shared/api/client.ts](/Users/a1/Projects/Syntra Trade Consultant/frontend/shared/api/client.ts) - API клиент

## Дальнейшие шаги
1. ✅ Добавить `email-validator` в requirements.txt
2. ✅ Создать `.env.production` с правильным API URL
3. ⏭️ Настроить автозапуск API сервера через systemd или PM2
4. ⏭️ Добавить мониторинг доступности API
