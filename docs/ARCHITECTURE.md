# ARCHITECTURE - Syntra Trade Consultant

> ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

## Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ
- [ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾Ğ±Ğ·Ğ¾Ñ€](#Ğ¾Ğ±Ñ‰Ğ¸Ğ¹-Ğ¾Ğ±Ğ·Ğ¾Ñ€)
- [ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹](#ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹-ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)
- [Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…](#Ğ±Ğ°Ğ·Ğ°-Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
- [ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…](#Ğ¿Ğ¾Ñ‚Ğ¾Ğº-Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
- [Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸](#Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸)
- [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ](#Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ)

---

## ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾Ğ±Ğ·Ğ¾Ñ€

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½

ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **Ğ¼Ğ½Ğ¾Ğ³Ğ¾ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²ÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ** Ñ Ñ‡ĞµÑ‚ĞºĞ¸Ğ¼ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Telegram Bot API                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  aiogram 3.x Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Handlers   â”‚  â”‚  Middleware  â”‚  â”‚  Routers  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Service Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  OpenAI  â”‚ â”‚ Together â”‚ â”‚CoinGecko â”‚ â”‚  CRUD  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  External APIs     â”‚  â”‚   PostgreSQL DB    â”‚
â”‚  - OpenAI          â”‚  â”‚   - Users          â”‚
â”‚  - Together        â”‚  â”‚   - Chat History   â”‚
â”‚  - CoinGecko       â”‚  â”‚   - Request Limits â”‚
â”‚  - CryptoPanic     â”‚  â”‚   - Cost Tracking  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹

1. **Separation of Concerns** - ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞ»Ğ¾Ğ¹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ ÑĞ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ
2. **Dependency Injection** - Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ½Ğ¶ĞµĞºÑ‚ÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· middleware
3. **Async First** - Ğ²ÑĞµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ I/O Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ
4. **Error Resilience** - retry logic, fallback Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹
5. **Cost Optimization** - ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ€Ğ¾ÑƒÑ‚Ğ¸Ğ½Ğ³ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹

---

## ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1. Presentation Layer (Handlers)

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:**
- ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²Ğ²Ğ¾Ğ´Ğ°
- Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ÑĞ¼Ğ¸ (FSM)

**ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:**
- `handlers/start.py` - /start ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°, Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ
- `handlers/help_cmd.py` - /help ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°, ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ°
- `handlers/limits.py` - /limits ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ²
- `handlers/chat.py` - AI-Ñ‡Ğ°Ñ‚ Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
- `handlers/crypto.py` - /price, /analyze, /market, /news
- `handlers/vision.py` - Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ¾Ğ² (Vision API)
- `handlers/menu.py` - Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
- `handlers/admin.py` - Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ (/admin, /admin_stats, /admin_users, /admin_costs)

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
```python
@router.message(Command("price"))
async def cmd_price(
    message: Message,
    session: AsyncSession  # Injected by middleware
):
    # 1. Validate input
    coin_id = extract_coin_id(message.text)

    # 2. Call service
    price = await coingecko_service.get_price(coin_id)

    # 3. Format and respond
    await message.answer(format_price_response(price))
```

### 2. Middleware Layer

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:**
- Ğ˜Ğ½Ğ¶ĞµĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
- ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ²

**ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:**

#### DatabaseMiddleware
```python
class DatabaseMiddleware(BaseMiddleware):
    """Ğ˜Ğ½Ğ¶ĞµĞºÑ‚Ğ¸Ñ‚ DB session Ğ² ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ handler"""
    async def __call__(self, handler, event, data):
        async with AsyncSessionLocal() as session:
            data['session'] = session
            return await handler(event, data)
```

#### SubscriptionMiddleware
```python
class SubscriptionMiddleware(BaseMiddleware):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ»"""
    async def __call__(self, handler, event, data):
        if not await check_subscription(event.from_user.id):
            await event.answer("âŒ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑˆĞ¸Ñ‚ĞµÑÑŒ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ»")
            return
        return await handler(event, data)
```

#### RequestLimitMiddleware
```python
class RequestLimitMiddleware(BaseMiddleware):
    """ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ 5 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²/Ğ´ĞµĞ½ÑŒ"""
    async def __call__(self, handler, event, data):
        session: AsyncSession = data['session']
        user_id = event.from_user.id

        # Check limit
        if await is_limit_exceeded(session, user_id):
            await event.answer("âŒ Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½")
            return

        # Increment counter
        await increment_request_count(session, user_id)

        return await handler(event, data)
```

#### AdminMiddleware
```python
class AdminMiddleware(BaseMiddleware):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    async def __call__(self, handler, event, data):
        from config.config import ADMIN_IDS

        user_id = event.from_user.id
        data['is_admin'] = user_id in ADMIN_IDS

        return await handler(event, data)
```

#### LanguageMiddleware
```python
class LanguageMiddleware(BaseMiddleware):
    """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ÑĞ·Ñ‹ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    async def __call__(self, handler, event, data):
        session: AsyncSession = data['session']
        user_id = event.from_user.id

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ğ‘Ğ” Ğ¸Ğ»Ğ¸ language_code Ğ¸Ğ· Telegram
        user = await get_user_by_telegram_id(session, user_id)
        language = user.language if user and user.language else 'ru'

        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² data Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² handlers
        data['language'] = language

        return await handler(event, data)
```

### 3. Service Layer

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:**
- Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
- Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼Ğ¸ API
- ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
- ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

**ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:**

#### OpenAI Service
```python
class OpenAIService:
    def __init__(self, api_key: str):
        self.client = AsyncOpenAI(api_key=api_key)

    @retry(wait=wait_exponential(min=1, max=60))
    async def get_completion(
        self,
        messages: list,
        stream: bool = False
    ):
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ GPT Ñ retry logic"""
        # Model routing
        model = self._select_model(messages)

        return await self.client.chat.completions.create(
            model=model,
            messages=messages,
            stream=stream
        )

    def _select_model(self, messages: list) -> str:
        """Ğ Ğ¾ÑƒÑ‚Ğ¸Ğ½Ğ³: gpt-4o Ğ´Ğ»Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ…, gpt-4o-mini Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ…"""
        total_tokens = sum(count_tokens(m['content']) for m in messages)
        # ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€Ğ¾Ğ³: 1500 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² (ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ 25-35%)
        return "gpt-4o" if total_tokens > 1500 else "gpt-4o-mini"
```

#### CoinGecko Service
```python
class CoinGeckoService:
    def __init__(self):
        self.cg = CoinGeckoAPI()
        self.cache = SimpleCache(ttl_seconds=60)

    async def get_price(self, coin_id: str):
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼"""
        cached = self.cache.get(f'price_{coin_id}')
        if cached:
            return cached

        price = await self._fetch_price(coin_id)
        self.cache.set(f'price_{coin_id}', price)
        return price
```

#### Binance Service
```python
class BinanceService:
    """Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚ Binance API Ğ´Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ñ†ĞµĞ½ Ğ¸ Ğ¾Ğ±ÑŠĞµĞ¼Ğ¾Ğ²"""
    async def get_ticker_24h(self, symbol: str):
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ 24h ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ñ‚Ğ¸ĞºĞµÑ€Ğ°"""
        pass

    async def get_klines(self, symbol: str, interval: str):
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ²ĞµÑ‡ĞµĞ¹ Ğ´Ğ»Ñ TA"""
        pass
```

#### Technical Indicators
```python
class TechnicalIndicators:
    """Ğ Ğ°ÑÑ‡ĞµÑ‚ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²"""
    @staticmethod
    def calculate_rsi(prices: list, period: int = 14) -> float:
        """Relative Strength Index"""
        pass

    @staticmethod
    def calculate_macd(prices: list):
        """MACD Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€"""
        pass

    @staticmethod
    def calculate_bollinger_bands(prices: list, period: int = 20):
        """Bollinger Bands"""
        pass

    @staticmethod
    def calculate_ema(prices: list, period: int) -> float:
        """Exponential Moving Average"""
        pass
```

#### Candlestick Patterns
```python
class CandlestickPatterns:
    """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ÑĞ²ĞµÑ‡Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²"""
    @staticmethod
    def is_doji(candle: dict) -> bool:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ° Doji"""
        pass

    @staticmethod
    def is_hammer(candle: dict) -> bool:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ° Hammer"""
        pass

    @staticmethod
    def is_engulfing(prev_candle: dict, curr_candle: dict) -> str:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ² Bullish/Bearish Engulfing"""
        pass
```

#### Retention Service
```python
class RetentionService:
    """Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞºĞ° ÑƒĞ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"""
    async def start_retention_service(self, bot: Bot):
        """Ğ—Ğ°Ğ¿ÑƒÑĞº retention scheduler"""
        pass

    async def send_retention_message(self, user_id: int, message_type: str):
        """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° retention ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ"""
        pass

    async def process_unsubscribed_users(self):
        """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½ĞµĞ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"""
        pass
```

#### Fear & Greed Service
```python
class FearGreedService:
    """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑĞ° ÑÑ‚Ñ€Ğ°Ñ…Ğ° Ğ¸ Ğ¶Ğ°Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸"""
    async def get_fear_greed_index(self):
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Fear & Greed Index"""
        pass
```

#### CryptoPanic Service
```python
class CryptoPanicService:
    """ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²Ğ°Ğ»ÑÑ‚Ğ½Ñ‹Ğµ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸"""
    async def get_news(self, currencies: list, filter_type: str):
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ°Ğ¼"""
        pass

    async def format_news_for_telegram(self, news: list) -> str:
        """Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹ Ğ´Ğ»Ñ Telegram"""
        pass
```

### 4. Data Layer

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:**
- CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
- Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ‘Ğ”
- Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸

**ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:**
```python
# database/crud.py
async def get_or_create_user(
    session: AsyncSession,
    telegram_id: int,
    username: str = None
) -> User:
    """Get existing user or create new"""
    stmt = select(User).where(User.telegram_id == telegram_id)
    result = await session.execute(stmt)
    user = result.scalar_one_or_none()

    if not user:
        user = User(telegram_id=telegram_id, username=username)
        session.add(user)
        await session.commit()
        await session.refresh(user)

    return user
```

---

## Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### ER-Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       users        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)            â”‚
â”‚ telegram_id (UQ)   â”‚â—„â”€â”€â”€â”€â”€â”
â”‚ username           â”‚      â”‚
â”‚ created_at         â”‚      â”‚
â”‚ is_subscribed      â”‚      â”‚
â”‚ last_activity      â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                            â”‚
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   chat_history     â”‚      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚ id (PK)            â”‚      â”‚
â”‚ user_id (FK) â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
â”‚ role               â”‚
â”‚ content            â”‚
â”‚ timestamp          â”‚
â”‚ tokens_used        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  request_limits    â”‚      â”‚   cost_tracking    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)            â”‚      â”‚ id (PK)            â”‚
â”‚ user_id (FK) â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”   â”‚ user_id (FK) â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”
â”‚ date               â”‚  â”‚   â”‚ service            â”‚  â”‚
â”‚ count              â”‚  â”‚   â”‚ tokens             â”‚  â”‚
â”‚ limit              â”‚  â”‚   â”‚ cost               â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ timestamp          â”‚  â”‚
                        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                        â”‚                           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚       users        â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞœĞ¾Ğ´ĞµĞ»Ğ¸ SQLAlchemy

```python
class User(Base):
    __tablename__ = 'users'

    id: Mapped[int] = mapped_column(BigInteger, primary_key=True)
    telegram_id: Mapped[int] = mapped_column(
        BigInteger,
        unique=True,
        index=True
    )
    username: Mapped[str] = mapped_column(String(255), nullable=True)
    created_at: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.utcnow
    )
    is_subscribed: Mapped[bool] = mapped_column(default=False)
    last_activity: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow
    )

    # Relationships
    chat_history = relationship("ChatHistory", back_populates="user")
    request_limits = relationship("RequestLimit", back_populates="user")
    cost_tracking = relationship("CostTracking", back_populates="user")


class ChatHistory(Base):
    __tablename__ = 'chat_history'

    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(
        BigInteger,
        ForeignKey('users.id'),
        index=True
    )
    role: Mapped[str] = mapped_column(String(50))  # user, assistant, system
    content: Mapped[str] = mapped_column(Text)
    timestamp: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.utcnow
    )
    tokens_used: Mapped[int] = mapped_column(Integer, nullable=True)

    # Relationship
    user = relationship("User", back_populates="chat_history")


class RequestLimit(Base):
    __tablename__ = 'request_limits'

    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(
        BigInteger,
        ForeignKey('users.id'),
        index=True
    )
    date: Mapped[date] = mapped_column(Date, default=date.today)
    count: Mapped[int] = mapped_column(Integer, default=0)
    limit: Mapped[int] = mapped_column(Integer, default=5)

    # Relationship
    user = relationship("User", back_populates="request_limits")

    # Unique constraint
    __table_args__ = (
        UniqueConstraint('user_id', 'date', name='uix_user_date'),
    )


class CostTracking(Base):
    __tablename__ = 'cost_tracking'

    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(
        BigInteger,
        ForeignKey('users.id'),
        index=True
    )
    service: Mapped[str] = mapped_column(String(50))  # openai, together
    tokens: Mapped[int] = mapped_column(Integer)
    cost: Mapped[float] = mapped_column(Float)
    timestamp: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.utcnow
    )

    # Relationship
    user = relationship("User", back_populates="cost_tracking")


class AdminLog(Base):
    __tablename__ = 'admin_logs'

    id: Mapped[int] = mapped_column(primary_key=True)
    admin_id: Mapped[int] = mapped_column(BigInteger)
    action: Mapped[str] = mapped_column(String(100))
    target_user_id: Mapped[int] = mapped_column(BigInteger, nullable=True)
    timestamp: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.utcnow
    )
    details: Mapped[str] = mapped_column(Text, nullable=True)
```

### Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹

```sql
-- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‡ĞµÑ€ĞµĞ· mapped_column(index=True)
CREATE INDEX ix_users_telegram_id ON users(telegram_id);
CREATE INDEX ix_chat_history_user_id ON chat_history(user_id);
CREATE INDEX ix_request_limits_user_id ON request_limits(user_id);
CREATE INDEX ix_cost_tracking_user_id ON cost_tracking(user_id);

-- Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ (Ñ‡ĞµÑ€ĞµĞ· Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸)
CREATE INDEX ix_chat_history_timestamp ON chat_history(timestamp DESC);
CREATE INDEX ix_request_limits_date ON request_limits(date);
CREATE INDEX ix_cost_tracking_service ON cost_tracking(service);
```

---

## ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° AI-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚ /analyze bitcoin
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Bot API                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  aiogram Dispatcher              â”‚
â”‚  - Update routing                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Middleware Chain                â”‚
â”‚  1. DatabaseMiddleware           â”‚  â† Inject DB session
â”‚  2. SubscriptionMiddleware       â”‚  â† Check subscription
â”‚  3. RequestLimitMiddleware       â”‚  â† Check & increment limit
â”‚  4. LoggingMiddleware            â”‚  â† Log request
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Handler: cmd_analyze            â”‚
â”‚  1. Extract coin_id from message â”‚
â”‚  2. Fetch price (CoinGecko)      â”‚
â”‚  3. Fetch news (CryptoPanic)     â”‚
â”‚  4. Form AI prompt               â”‚
â”‚  5. Call OpenAI (streaming)      â”‚
â”‚  6. Save to ChatHistory          â”‚
â”‚  7. Track costs                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CoinGecko  â”‚  â”‚  OpenAI     â”‚
â”‚  Service    â”‚  â”‚  Service    â”‚
â”‚  - Cache    â”‚  â”‚  - Stream   â”‚
â”‚  - Retry    â”‚  â”‚  - Retry    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Streaming       â”‚
            â”‚  Response        â”‚
            â”‚  to User         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Vision Analysis (Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚ [Sends photo]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Handler: handle_photo           â”‚
â”‚  1. Download photo (bot.download)â”‚
â”‚  2. Convert to base64            â”‚
â”‚  3. Send to Together API         â”‚
â”‚  4. Parse vision response        â”‚
â”‚  5. Format TA output             â”‚
â”‚  6. Save to DB                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Together Service (Qwen 2.5 VL)  â”‚
â”‚  - Vision analysis               â”‚
â”‚  - Pattern recognition           â”‚
â”‚  - Support/Resistance levels     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response to User                â”‚
â”‚  ğŸ“Š Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·:          â”‚
â”‚  - Ğ¢Ñ€ĞµĞ½Ğ´: Ğ²Ğ¾ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹             â”‚
â”‚  - ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°: $44,000            â”‚
â”‚  - Ğ¡Ğ¾Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: $48,000        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞºĞ° ÑƒĞ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APScheduler                     â”‚
â”‚  - Runs every hour               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Retention Service               â”‚
â”‚  1. Query unsubscribed users     â”‚
â”‚  2. Check time since /start      â”‚
â”‚  3. Select message template      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼         â–¼         â–¼          â–¼
   1 hour   24 hours  7 days   14 days
   "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! "Ğ¡ĞºÑƒÑ‡Ğ°ĞµĞ¼" "Ğ§Ñ‚Ğ¾-Ñ‚Ğ¾  "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹
    ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹          ÑĞ»ÑƒÑ‡Ğ¸Ğ»Ğ¾ÑÑŒ? ÑˆĞ°Ğ½Ñ!"
    Ğ±Ğ¾Ñ‚Ğ°!"            Ğ’ĞµÑ€Ğ½Ğ¸ÑÑŒ!"
```

---

## Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

### OpenAI API

**Endpoint:** `https://api.openai.com/v1/chat/completions`

**ĞœĞ¾Ğ´ĞµĞ»Ğ¸:**
- `gpt-4o` - ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ (>500 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ² Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğµ)
- `gpt-4o-mini` - Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹

**Rate Limits:**
- Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ tier (500K-10M TPM)
- Retry Ñ exponential backoff

**Cost Optimization:**
- Ğ Ğ¾ÑƒÑ‚Ğ¸Ğ½Ğ³ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸
- ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ´Ğ½Ğ¾Ñ‚Ğ¸Ğ¿Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² (Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ, Ñ‚.Ğº. Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹)
- ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ max_tokens
- Ğ¡ÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²

### Together API

**Endpoint:** `https://api.together.xyz/v1/chat/completions`

**ĞœĞ¾Ğ´ĞµĞ»ÑŒ:**
- `Qwen/Qwen2-VL-72B-Instruct` (Ğ¸Ğ»Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³)

**Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
- Vision analysis (Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ¾Ğ²)
- Ğ Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²
- OCR Ñ‚ĞµĞºÑÑ‚Ğ° Ğ½Ğ° Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞµ

### CoinGecko API

**Endpoint:** `https://api.coingecko.com/api/v3/`

**Endpoints:**
- `/simple/price` - Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ñ†ĞµĞ½Ğ°
- `/coins/{id}/ohlc` - OHLC Ğ´Ğ»Ñ TA
- `/coins/markets` - Ñ‚Ğ¾Ğ¿ Ğ¼Ğ¾Ğ½ĞµÑ‚

**Rate Limits:**
- Free: 5-15 calls/min
- **MUST CACHE** (60 ÑĞµĞºÑƒĞ½Ğ´ TTL)

### CryptoPanic API

**Endpoint:** `https://cryptopanic.com/api/v1/posts/`

**Parameters:**
- `currencies` - Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ°Ğ¼ (BTC, ETH)
- `filter` - hot, rising, bullish, bearish

**ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
- 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ TTL

---

## Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### 1. ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

```python
# âŒ ĞĞ• Ğ”Ğ•Ğ›ĞĞ™Ğ¢Ğ• Ğ¢ĞĞš
OPENAI_API_KEY = "sk-1234567890..."

# âœ… ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ
from dotenv import load_dotenv
import os

load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
```

### 2. SQL Injection Protection

SQLAlchemy Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:

```python
# âœ… Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾
stmt = select(User).where(User.username == user_input)

# âŒ ĞĞ• Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ™Ğ¢Ğ• RAW SQL Ñ user input
# query = f"SELECT * FROM users WHERE username = '{user_input}'"
```

### 3. Rate Limiting

```python
# Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑĞ¿Ğ°Ğ¼Ğ°
@router.message(Command("analyze"))
@rate_limit(max_calls=5, period=60)  # 5 calls per minute
async def cmd_analyze(message: Message):
    ...
```

### 4. Admin Authorization

```python
ADMIN_IDS = [123456789, 987654321]

def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

@router.message(Command("admin_stats"))
async def cmd_admin_stats(message: Message):
    if not is_admin(message.from_user.id):
        await message.answer("âŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½")
        return
    # Admin logic...
```

### 5. Data Sanitization

```python
from html import escape

async def safe_answer(message: Message, text: str):
    # Escape HTML entities
    safe_text = escape(text)
    await message.answer(safe_text)
```

---

## ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** aiogram Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ long polling - Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ½ÑÑ‚Ğ°Ğ½ÑĞ¾Ğ²

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
1. **Webhooks** Ğ²Ğ¼ĞµÑÑ‚Ğ¾ polling
2. **Load Balancer** (nginx) Ğ´Ğ»Ñ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
3. **Redis** Ğ´Ğ»Ñ shared state (FSM storage)

```python
# Webhook mode
from aiogram.webhook.aiohttp_server import SimpleRequestHandler

async def main():
    bot = Bot(token=BOT_TOKEN)
    dp = Dispatcher()

    # Webhook URL
    WEBHOOK_URL = "https://yourdomain.com/webhook"

    # Start webhook
    await bot.set_webhook(WEBHOOK_URL)

    # aiohttp app
    app = web.Application()
    SimpleRequestHandler(
        dispatcher=dp,
        bot=bot
    ).register(app, path="/webhook")

    web.run_app(app, host="0.0.0.0", port=8000)
```

### Database Scaling

**Connection Pooling:**
```python
engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,  # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ prod
    max_overflow=40
)
```

**Read Replicas** (Ğ´Ğ»Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¹ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸):
```python
# Master Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
write_engine = create_async_engine(WRITE_DB_URL)

# Replica Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ
read_engine = create_async_engine(READ_DB_URL)
```

### Caching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Request    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Redis Cache â”‚ â† L1 Cache (shared)
 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ miss
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ In-Memory    â”‚ â† L2 Cache (per-instance)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ miss
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ External API â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ´ĞµĞ¿Ğ»Ğ¾Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Internet                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Telegram Servers   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   nginx (optional)   â”‚ â† Webhook mode
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚
        â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Bot         â”‚      â”‚  Bot         â”‚
â”‚  Instance 1  â”‚      â”‚  Instance 2  â”‚ â† Horizontal scaling
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚
    â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Postgresâ”‚         â”‚  Redis   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ›Ğ¾Ğ³Ğ¸

```
logs/
â”œâ”€â”€ bot.log          # ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸
â”œâ”€â”€ error.log        # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
â””â”€â”€ access.log       # Access logs (webhook mode)
```

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸

```python
# Prometheus metrics
from prometheus_client import Counter, Histogram, Gauge

# Counters
requests_total = Counter(
    'bot_requests_total',
    'Total requests',
    ['command', 'status']
)

# Histogram
response_time = Histogram(
    'bot_response_seconds',
    'Response time'
)

# Gauge
active_users = Gauge(
    'bot_active_users',
    'Active users in last 24h'
)
```

---

## Ğ—Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ

ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼:
- âœ… ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚Ğ¸
- âœ… ĞĞ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸ (retry, fallback)
- âœ… Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸ (ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ€Ğ¾ÑƒÑ‚Ğ¸Ğ½Ğ³)
- âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ (Ñ‡Ğ¸ÑÑ‚Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°)
- âœ… Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ (env vars, SQL injection protection)
