# NOWPayments - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è Syntra AI

## –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è NOWPayments

### ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ê–∫–∫–∞—É–Ω—Ç NOWPayments** (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞)
2. **Email –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏**
3. **–ö—Ä–∏–ø—Ç–æ-–∫–æ—à–µ–ª–µ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤** (–ª—é–±–æ–π –∏–∑ 300+ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö)
4. **–ë–µ–∑ KYC** –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ (–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞)
5. **–ë–µ–∑ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞**

### üí∞ –ö–æ–º–∏—Å—Å–∏–∏

- **0.5%** - –æ–¥–Ω–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞
- **1.0%** - –∫–æ–Ω–≤–µ—Ä—Å–∏—è –º–µ–∂–¥—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:** ~$1 (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç 0.003 BTC)

---

## üìù –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞

### 1.1 –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://nowpayments.io/
2. –ù–∞–∂–∞—Ç—å **"Get started"** –∏–ª–∏ **"Create account"**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
   - Email
   - –ü–∞—Ä–æ–ª—å (—Å–∏–ª—å–Ω—ã–π!)
   - –ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è

### 1.2 –ê–∫—Ç–∏–≤–∞—Ü–∏—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å email
2. –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ —Å—Å—ã–ª–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
3. –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç

### 1.3 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **–í–∫–ª—é—á–∏—Ç—å 2FA** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
   - Dashboard ‚Üí Security ‚Üí Two-Factor Authentication
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Authenticator –∏–ª–∏ Authy

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Whitelist** (–¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤)
   - Dashboard ‚Üí Security ‚Üí Withdrawal Whitelist
   - –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å–∞ –∫–æ—à–µ–ª—å–∫–æ–≤

---

## üîë –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–∞

### 2.1 –°–æ–∑–¥–∞–Ω–∏–µ API –∫–ª—é—á–∞

1. –í–æ–π—Ç–∏ –≤ Dashboard: https://account.nowpayments.io/
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ **Settings ‚Üí API Keys**
3. –ù–∞–∂–∞—Ç—å **"Add new key"**
4. **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API –∫–ª—é—á** (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!)

### 2.2 Sandbox –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://sandbox.nowpayments.io/
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å Sandbox –∞–∫–∫–∞—É–Ω—Ç
3. –ü–æ–ª—É—á–∏—Ç—å **Sandbox API Key**
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–í–ê–ñ–ù–û:** Sandbox –∏ Production - —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã!

---

## üí≥ –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞

### 3.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Outcome Wallet

1. Dashboard ‚Üí **Outcome Wallet**
2. –í—ã–±—Ä–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, USDT TRC20)
3. –í–≤–µ—Å—Ç–∏ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **USDT TRC20** - –Ω–∏–∑–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ —Å–µ—Ç–∏ (~$1)
- **USDT ERC20** - –≤—ã—Å–æ–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ (~$10-50)
- **TON** - –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã, –Ω–∏–∑–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏

### 3.2 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. Dashboard ‚Üí Settings ‚Üí **Auto Withdrawal**
2. –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–≤—ã–≤–æ–¥
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ)
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É

---

## üêç –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python SDK

### 4.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞

```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source .venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å NOWPayments SDK
pip install nowpayment

# –ò–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞–∫–µ—Ç
pip install nowpayments-api
```

### 4.2 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ requirements.txt

```txt
# requirements.txt
nowpayment>=1.0.0  # NOWPayments SDK
```

---

## üîß –®–∞–≥ 5: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ

### 5.1 –î–æ–±–∞–≤–∏—Ç—å –≤ .env

```bash
# .env

# NOWPayments API Configuration
NOWPAYMENTS_API_KEY=your_api_key_here
NOWPAYMENTS_IPN_SECRET=your_ipn_secret_here  # –î–ª—è webhook –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
NOWPAYMENTS_SANDBOX=true  # false –¥–ª—è production

# Outcome wallet (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤)
NOWPAYMENTS_OUTCOME_WALLET=TYourUSDTTRC20AddressHere
```

### 5.2 –î–æ–±–∞–≤–∏—Ç—å –≤ .env.example

```bash
# .env.example

# NOWPayments API Configuration
# Get your API key from: https://account.nowpayments.io/
# Supports 300+ cryptocurrencies with 0.5% fee
NOWPAYMENTS_API_KEY=
NOWPAYMENTS_IPN_SECRET=
NOWPAYMENTS_SANDBOX=true
NOWPAYMENTS_OUTCOME_WALLET=
```

---

## üíª –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞

### 6.1 –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å–µ—Ä–≤–∏—Å–∞

```python
# src/services/nowpayments_service.py
"""
NOWPayments Service –¥–ª—è Syntra AI

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π –≤ 300+ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞—Ö
- –ê–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ —Ñ–∏–∞—Ç
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
- Invoice management
"""

import os
import hmac
import hashlib
from typing import Optional, Dict, Any
from decimal import Decimal
from datetime import datetime, timedelta, UTC

from nowpayment import NowPayments
from loguru import logger
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from src.database.models import (
    User,
    Payment,
    PaymentProvider,
    PaymentStatus,
    SubscriptionTier,
)


class NOWPaymentsService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å NOWPayments API

    Features:
    - 300+ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç + 75+ —Ñ–∏–∞—Ç–Ω—ã—Ö –≤–∞–ª—é—Ç
    - –ö–æ–º–∏—Å—Å–∏—è: 0.5% (–æ–¥–Ω–∞ –≤–∞–ª—é—Ç–∞) –∏–ª–∏ 1% (–∫–æ–Ω–≤–µ—Ä—Å–∏—è)
    - –ê–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Å–∏—è –∫—Ä–∏–ø—Ç—ã –≤ —Ñ–∏–∞—Ç
    - Non-custodial (–≤—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞)
    """

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NOWPayments client"""
        self.api_key = os.getenv("NOWPAYMENTS_API_KEY", "")
        self.ipn_secret = os.getenv("NOWPAYMENTS_IPN_SECRET", "")
        self.is_sandbox = os.getenv("NOWPAYMENTS_SANDBOX", "true").lower() == "true"

        if not self.api_key:
            logger.warning("‚ö†Ô∏è NOWPAYMENTS_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
            self.client = None
            return

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç
        self.client = NowPayments(self.api_key)

        network = "Sandbox" if self.is_sandbox else "Production"
        logger.info(f"‚úÖ NOWPaymentsService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ({network})")

    async def get_available_currencies(self) -> list[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç

        Returns:
            –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ä–æ–≤ –≤–∞–ª—é—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: ['BTC', 'ETH', 'USDT', ...])
        """
        if not self.client:
            return []

        try:
            currencies = self.client.currency.get_available_currencies()
            logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(currencies)} –≤–∞–ª—é—Ç")
            return currencies
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞–ª—é—Ç: {e}")
            return []

    async def estimate_price(
        self,
        amount_usd: float,
        currency_from: str = "usd",
        currency_to: str = "btc"
    ) -> Optional[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ—Ü–µ–Ω–∫—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

        Args:
            amount_usd: –°—É–º–º–∞ –≤ USD
            currency_from: –ò—Å—Ö–æ–¥–Ω–∞—è –≤–∞–ª—é—Ç–∞ (default: usd)
            currency_to: –¶–µ–ª–µ–≤–∞—è –≤–∞–ª—é—Ç–∞ (default: btc)

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –æ—Ü–µ–Ω–∫–æ–π: {
                "currency_from": "usd",
                "amount_from": 100.0,
                "currency_to": "btc",
                "estimated_amount": 0.00234
            }
        """
        if not self.client:
            return None

        try:
            estimate = self.client.currency.get_estimate(
                amount=amount_usd,
                currency_from=currency_from,
                currency_to=currency_to
            )

            logger.info(
                f"üí± –û—Ü–µ–Ω–∫–∞: {amount_usd} {currency_from.upper()} = "
                f"{estimate['estimated_amount']} {currency_to.upper()}"
            )

            return estimate

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ —Ü–µ–Ω—ã: {e}")
            return None

    async def create_payment(
        self,
        session: AsyncSession,
        user_id: int,
        tier: SubscriptionTier,
        duration_months: int,
        amount_usd: Decimal,
        pay_currency: str = "btc",
        order_description: Optional[str] = None,
    ) -> Optional[Dict[str, Any]]:
        """
        –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ NOWPayments

        Args:
            session: Database session
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            tier: Subscription tier
            duration_months: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏
            amount_usd: –°—É–º–º–∞ –≤ USD
            pay_currency: –í–∞–ª—é—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã (btc, eth, usdt –∏ —Ç.–¥.)
            order_description: –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞: {
                "payment_id": "123456789",
                "payment_url": "https://nowpayments.io/payment/...",
                "pay_address": "bc1q...",
                "pay_amount": 0.00234,
                "pay_currency": "btc",
                "price_amount": 100.0,
                "price_currency": "usd",
                "expires_at": "2025-01-26T12:00:00Z"
            }
        """
        if not self.client:
            logger.error("‚ùå NOWPayments client –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return None

        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º order_id
            timestamp = int(datetime.now(UTC).timestamp())
            order_id = f"syntra_{user_id}_{tier.value}_{duration_months}m_{timestamp}"

            # –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
            if not order_description:
                tier_names = {
                    SubscriptionTier.BASIC: "Basic",
                    SubscriptionTier.PREMIUM: "Premium",
                    SubscriptionTier.VIP: "VIP"
                }
                duration_text = f"{duration_months} month" if duration_months == 1 else f"{duration_months} months"
                order_description = f"Syntra AI {tier_names[tier]} - {duration_text}"

            # –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ SDK
            payment_response = self.client.payment.create_payment(
                price_amount=float(amount_usd),
                price_currency="usd",
                pay_currency=pay_currency.lower(),
                order_id=order_id,
                order_description=order_description,
                ipn_callback_url=f"{os.getenv('WEBAPP_URL', '')}/api/webhooks/nowpayments",  # Webhook URL
                success_url=f"{os.getenv('WEBAPP_URL', '')}/payment/success",
                cancel_url=f"{os.getenv('WEBAPP_URL', '')}/payment/cancel",
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –ë–î
            payment = Payment(
                user_id=user_id,
                provider=PaymentProvider.NOWPAYMENTS,  # –î–æ–±–∞–≤–∏–º –≤ enum
                amount=amount_usd,
                currency="USD",
                status=PaymentStatus.PENDING,
                tier=tier.value,
                duration_months=duration_months,
                provider_payment_id=str(payment_response["payment_id"]),
                provider_data={
                    "order_id": order_id,
                    "pay_address": payment_response.get("pay_address"),
                    "pay_amount": payment_response.get("pay_amount"),
                    "pay_currency": pay_currency,
                    "payment_url": payment_response.get("payment_url"),
                    "expires_at": payment_response.get("expiration_estimate_date"),
                },
            )

            session.add(payment)
            await session.commit()
            await session.refresh(payment)

            logger.info(
                f"‚úÖ NOWPayments –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω: user={user_id}, tier={tier.value}, "
                f"amount=${amount_usd}, pay_currency={pay_currency}, "
                f"payment_id={payment_response['payment_id']}"
            )

            return {
                "payment_id": payment_response["payment_id"],
                "payment_url": payment_response.get("payment_url"),
                "pay_address": payment_response.get("pay_address"),
                "pay_amount": payment_response.get("pay_amount"),
                "pay_currency": pay_currency,
                "price_amount": float(amount_usd),
                "price_currency": "usd",
                "expires_at": payment_response.get("expiration_estimate_date"),
                "db_payment_id": payment.id,
            }

        except Exception as e:
            logger.exception(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è NOWPayments –ø–ª–∞—Ç–µ–∂–∞: {e}")
            await session.rollback()
            return None

    async def create_invoice(
        self,
        session: AsyncSession,
        user_id: int,
        tier: SubscriptionTier,
        duration_months: int,
        amount_usd: Decimal,
        order_description: Optional[str] = None,
    ) -> Optional[Dict[str, Any]]:
        """
        –°–æ–∑–¥–∞—Ç—å invoice (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞–ª—é—Ç—É —Å–∞–º)

        –û—Ç–ª–∏—á–∏–µ –æ—Ç create_payment:
        - Invoice: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞–ª—é—Ç—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ NOWPayments
        - Payment: –≤–∞–ª—é—Ç–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞—Ä–∞–Ω–µ–µ

        Args:
            session: Database session
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            tier: Subscription tier
            duration_months: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏
            amount_usd: –°—É–º–º–∞ –≤ USD
            order_description: –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ invoice: {
                "invoice_id": "123456789",
                "invoice_url": "https://nowpayments.io/payment/...",
                "price_amount": 100.0,
                "price_currency": "usd",
                "expires_at": "2025-01-26T12:00:00Z"
            }
        """
        if not self.client:
            logger.error("‚ùå NOWPayments client –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return None

        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º order_id
            timestamp = int(datetime.now(UTC).timestamp())
            order_id = f"syntra_{user_id}_{tier.value}_{duration_months}m_{timestamp}"

            # –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
            if not order_description:
                tier_names = {
                    SubscriptionTier.BASIC: "Basic",
                    SubscriptionTier.PREMIUM: "Premium",
                    SubscriptionTier.VIP: "VIP"
                }
                duration_text = f"{duration_months} month" if duration_months == 1 else f"{duration_months} months"
                order_description = f"Syntra AI {tier_names[tier]} - {duration_text}"

            # –°–æ–∑–¥–∞–µ–º invoice —á–µ—Ä–µ–∑ SDK
            invoice_response = self.client.payment.create_invoice(
                price_amount=float(amount_usd),
                price_currency="usd",
                order_id=order_id,
                order_description=order_description,
                ipn_callback_url=f"{os.getenv('WEBAPP_URL', '')}/api/webhooks/nowpayments",
                success_url=f"{os.getenv('WEBAPP_URL', '')}/payment/success",
                cancel_url=f"{os.getenv('WEBAPP_URL', '')}/payment/cancel",
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –ë–î
            payment = Payment(
                user_id=user_id,
                provider=PaymentProvider.NOWPAYMENTS,
                amount=amount_usd,
                currency="USD",
                status=PaymentStatus.PENDING,
                tier=tier.value,
                duration_months=duration_months,
                provider_payment_id=str(invoice_response["id"]),
                provider_data={
                    "order_id": order_id,
                    "invoice_url": invoice_response.get("invoice_url"),
                    "expires_at": invoice_response.get("created_at"),  # Invoice –æ–±—ã—á–Ω–æ –Ω–µ –∏—Å—Ç–µ–∫–∞–µ—Ç
                },
            )

            session.add(payment)
            await session.commit()
            await session.refresh(payment)

            logger.info(
                f"‚úÖ NOWPayments invoice —Å–æ–∑–¥–∞–Ω: user={user_id}, tier={tier.value}, "
                f"amount=${amount_usd}, invoice_id={invoice_response['id']}"
            )

            return {
                "invoice_id": invoice_response["id"],
                "invoice_url": invoice_response.get("invoice_url"),
                "price_amount": float(amount_usd),
                "price_currency": "usd",
                "created_at": invoice_response.get("created_at"),
                "db_payment_id": payment.id,
            }

        except Exception as e:
            logger.exception(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è NOWPayments invoice: {e}")
            await session.rollback()
            return None

    async def get_payment_status(
        self,
        payment_id: str
    ) -> Optional[Dict[str, Any]]:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞

        Args:
            payment_id: NOWPayments payment ID

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –ø–ª–∞—Ç–µ–∂–∞
        """
        if not self.client:
            return None

        try:
            status = self.client.payment.get_payment_status(payment_id)

            logger.info(f"üìä –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ {payment_id}: {status.get('payment_status')}")

            return status

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞: {e}")
            return None

    def verify_ipn_signature(
        self,
        request_body: bytes,
        signature: str
    ) -> bool:
        """
        –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å IPN webhook signature

        Args:
            request_body: Raw request body (bytes)
            signature: Signature from x-nowpayments-sig header

        Returns:
            True –µ—Å–ª–∏ signature –≤–∞–ª–∏–¥–Ω–∞
        """
        if not self.ipn_secret:
            logger.warning("‚ö†Ô∏è NOWPAYMENTS_IPN_SECRET –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
            return False

        try:
            # –í—ã—á–∏—Å–ª—è–µ–º HMAC-SHA512
            expected_signature = hmac.new(
                self.ipn_secret.encode(),
                request_body,
                hashlib.sha512
            ).hexdigest()

            # Constant-time comparison
            is_valid = hmac.compare_digest(signature, expected_signature)

            if not is_valid:
                logger.warning("‚ùå Invalid IPN signature")

            return is_valid

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ signature: {e}")
            return False

    async def process_ipn_callback(
        self,
        session: AsyncSession,
        ipn_data: Dict[str, Any]
    ) -> bool:
        """
        –û–±—Ä–∞–±–æ—Ç–∞—Ç—å IPN callback –æ—Ç NOWPayments

        IPN —Å—Ç–∞—Ç—É—Å—ã:
        - waiting: –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
        - confirming: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        - confirmed: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
        - sending: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ outcome wallet
        - finished: –ü–ª–∞—Ç–µ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω
        - failed: –ü–ª–∞—Ç–µ–∂ –Ω–µ —É–¥–∞–ª—Å—è
        - refunded: –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
        - expired: –ò—Å—Ç–µ–∫ —Å—Ä–æ–∫ –ø–ª–∞—Ç–µ–∂–∞

        Args:
            session: Database session
            ipn_data: IPN –¥–∞–Ω–Ω—ã–µ –æ—Ç NOWPayments

        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
        """
        try:
            payment_id = ipn_data.get("payment_id")
            payment_status = ipn_data.get("payment_status")
            order_id = ipn_data.get("order_id")

            logger.info(f"üì® IPN callback: payment_id={payment_id}, status={payment_status}")

            # –ù–∞—Ö–æ–¥–∏–º –ø–ª–∞—Ç–µ–∂ –≤ –ë–î
            result = await session.execute(
                select(Payment).where(
                    Payment.provider_payment_id == str(payment_id)
                )
            )
            payment = result.scalar_one_or_none()

            if not payment:
                logger.warning(f"‚ö†Ô∏è –ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω: payment_id={payment_id}")
                return False

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if payment_status == "finished":
                payment.status = PaymentStatus.COMPLETED
                payment.completed_at = datetime.now(UTC)

                # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
                from src.database.crud import activate_subscription
                await activate_subscription(
                    session,
                    payment.user_id,
                    SubscriptionTier(payment.tier),
                    payment.duration_months
                )

                logger.success(
                    f"‚úÖ –ü–ª–∞—Ç–µ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω: user={payment.user_id}, "
                    f"tier={payment.tier}, payment_id={payment_id}"
                )

            elif payment_status in ["failed", "expired", "refunded"]:
                payment.status = PaymentStatus.FAILED
                logger.warning(f"‚ö†Ô∏è –ü–ª–∞—Ç–µ–∂ –Ω–µ —É–¥–∞–ª—Å—è: payment_id={payment_id}, status={payment_status}")

            else:
                # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã (waiting, confirming, confirmed, sending)
                logger.info(f"üìä –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å: {payment_status}")

            # –û–±–Ω–æ–≤–ª—è–µ–º metadata
            payment.provider_data["ipn_data"] = ipn_data
            payment.provider_data["last_status_update"] = datetime.now(UTC).isoformat()

            await session.commit()

            return True

        except Exception as e:
            logger.exception(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ IPN callback: {e}")
            await session.rollback()
            return False


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π singleton
_nowpayments_service: Optional[NOWPaymentsService] = None


def get_nowpayments_service() -> NOWPaymentsService:
    """–ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä NOWPaymentsService (—Å–∏–Ω–≥–ª—Ç–æ–Ω)"""
    global _nowpayments_service

    if _nowpayments_service is None:
        _nowpayments_service = NOWPaymentsService()

    return _nowpayments_service
```

---

## üîî –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhooks (IPN)

### 7.1 –ü–æ–ª—É—á–∏—Ç—å IPN Secret

1. Dashboard ‚Üí Settings ‚Üí **IPN Secret Key**
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á
3. –î–æ–±–∞–≤–∏—Ç—å –≤ `.env` –∫–∞–∫ `NOWPAYMENTS_IPN_SECRET`

### 7.2 –°–æ–∑–¥–∞—Ç—å Webhook Endpoint

```python
# src/api/webhooks_nowpayments.py
"""
NOWPayments Webhook Handler
"""

from fastapi import APIRouter, Request, HTTPException, Depends, Header
from sqlalchemy.ext.asyncio import AsyncSession

from src.database.engine import get_session
from src.services.nowpayments_service import get_nowpayments_service
from loguru import logger


router = APIRouter(prefix="/webhooks", tags=["webhooks"])


@router.post("/nowpayments")
async def nowpayments_ipn_callback(
    request: Request,
    session: AsyncSession = Depends(get_session),
    x_nowpayments_sig: str = Header(None),
):
    """
    IPN Callback –æ—Ç NOWPayments

    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞:
    - waiting ‚Üí confirming ‚Üí confirmed ‚Üí sending ‚Üí finished

    Security: –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º HMAC-SHA512 signature
    """
    try:
        # –ß–∏—Ç–∞–µ–º raw body
        body = await request.body()

        # –ü–∞—Ä—Å–∏–º JSON
        ipn_data = await request.json()

        # –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º signature
        service = get_nowpayments_service()

        if not service.verify_ipn_signature(body, x_nowpayments_sig):
            logger.error("‚ùå Invalid IPN signature!")
            raise HTTPException(status_code=403, detail="Invalid signature")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback
        success = await service.process_ipn_callback(session, ipn_data)

        if success:
            return {"status": "ok"}
        else:
            raise HTTPException(status_code=400, detail="Failed to process IPN")

    except Exception as e:
        logger.exception(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ IPN: {e}")
        raise HTTPException(status_code=500, detail="Internal server error")
```

### 7.3 –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä

```python
# src/api/router.py

from src.api import webhooks_nowpayments

# –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–æ—É—Ç–µ—Ä
app.include_router(webhooks_nowpayments.router, prefix="/api")
```

---

## üöÄ –®–∞–≥ 8: –°–æ–∑–¥–∞–Ω–∏–µ Payment API

```python
# src/api/payment.py

from src.services.nowpayments_service import get_nowpayments_service


@router.post("/nowpayments/create-invoice", response_model=PaymentResponse)
async def create_nowpayments_invoice(
    request: CreateNOWPaymentsInvoiceRequest,
    user: User = Depends(get_current_user),
    session: AsyncSession = Depends(get_session),
):
    """
    –°–æ–∑–¥–∞—Ç—å NOWPayments invoice

    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞–ª—é—Ç—É (–∏–∑ 300+) –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã
    """
    try:
        # Validate tier
        tier = SubscriptionTier(request.tier)

        # Validate duration
        if request.duration_months not in [1, 3, 12]:
            raise HTTPException(status_code=400, detail="Invalid duration")

        # Get plan price
        from src.services.telegram_stars_service import TelegramStarsService
        stars_service = TelegramStarsService()
        plan = stars_service.get_plan_details(tier, request.duration_months)
        amount_usd = Decimal(str(plan["usd"]))

        # Create invoice
        service = get_nowpayments_service()
        invoice = await service.create_invoice(
            session=session,
            user_id=user.id,
            tier=tier,
            duration_months=request.duration_months,
            amount_usd=amount_usd,
        )

        if not invoice:
            raise HTTPException(status_code=500, detail="Failed to create invoice")

        logger.info(
            f"‚úÖ NOWPayments invoice: user={user.id}, tier={tier.value}, "
            f"amount=${amount_usd}, invoice_id={invoice['invoice_id']}"
        )

        return PaymentResponse(
            success=True,
            message="Invoice created successfully",
            data={
                "invoice_id": invoice["invoice_id"],
                "invoice_url": invoice["invoice_url"],
                "amount_usd": float(amount_usd),
                "tier": tier.value,
                "duration_months": request.duration_months,
            },
        )

    except Exception as e:
        logger.exception(f"‚ùå Error creating NOWPayments invoice: {e}")
        return PaymentResponse(
            success=False,
            message="Failed to create invoice",
            error=str(e)
        )
```

---

## ‚úÖ –®–∞–≥ 9: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 9.1 Sandbox —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Sandbox API Key**
2. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π invoice
3. –û—Ç–∫—Ä—ã—Ç—å `invoice_url` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
4. –í—ã–±—Ä–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã

### 9.2 Production –ø—Ä–æ–≤–µ—Ä–∫–∞

1. –°–æ–∑–¥–∞—Ç—å invoice —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º–æ–π ($1-2)
2. –û–ø–ª–∞—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–π –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook callbacks
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∫–∏

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### Dashboard

- https://account.nowpayments.io/payments - –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏
- https://account.nowpayments.io/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- https://account.nowpayments.io/logs - IPN –ª–æ–≥–∏

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

```python
# –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
logger.info(f"‚úÖ Invoice created: {invoice_id}")
logger.warning(f"‚ö†Ô∏è Payment status: {status}")
logger.error(f"‚ùå Payment failed: {error}")
logger.success(f"üí∞ Payment completed: ${amount}")
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Checklist

- ‚úÖ **–í–∫–ª—é—á–∏—Ç—å 2FA** –≤ –∞–∫–∫–∞—É–Ω—Ç–µ
- ‚úÖ **–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å IPN signature** (HMAC-SHA512)
- ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Whitelist** –¥–ª—è withdrawal –∞–¥—Ä–µ—Å–æ–≤
- ‚úÖ **–•—Ä–∞–Ω–∏—Ç—å API –∫–ª—é—á –≤ .env** (–Ω–µ –≤ –∫–æ–¥–µ!)
- ‚úÖ **–ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å API –∫–ª—é—á–∏**
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–µ–π** (–∑–∞—â–∏—Ç–∞ –æ—Ç –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π)

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- **Dashboard:** https://account.nowpayments.io/
- **Sandbox:** https://sandbox.nowpayments.io/
- **API Docs:** https://documenter.getpostman.com/view/7907941/2s93JusNJt
- **Integration Guide:** https://nowpayments.io/blog/integration-guide
- **Support:** https://nowpayments.io/help

### Python SDK

- **PyPI:** https://pypi.org/project/nowpayment/
- **GitHub:** https://github.com/Ventura94/NOWPayments-Python-API
- **Alternative SDK:** https://github.com/NikolaiSch/NowPay-python

---

## ‚è± –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –≠—Ç–∞–ø | –í—Ä–µ–º—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-------|----------|
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | 10 –º–∏–Ω | –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ + 2FA |
| API –∫–ª—é—á | 5 –º–∏–Ω | –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ |
| –ö–æ—à–µ–ª–µ–∫ | 5 –º–∏–Ω | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ outcome wallet |
| –ö–æ–¥ —Å–µ—Ä–≤–∏—Å–∞ | 2-3 —á–∞—Å–∞ | –ù–∞–ø–∏—Å–∞–Ω–∏–µ NOWPaymentsService |
| Webhook endpoint | 1 —á–∞—Å | IPN callback –æ–±—Ä–∞–±–æ—Ç–∫–∞ |
| API endpoints | 1-2 —á–∞—Å–∞ | Payment API |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 2-3 —á–∞—Å–∞ | Sandbox + production —Ç–µ—Å—Ç—ã |
| **–ò–¢–û–ì–û** | **1-2 –¥–Ω—è** | –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è |

---

## üí° Pro Tips

### 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Invoice –≤–º–µ—Å—Ç–æ Payment

**Invoice** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞–ª—é—Ç—É —Å–∞–º
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 300+ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
- –ü—Ä–æ—â–µ UX

**Payment** (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª—é—Ç–∞):
- –í–∞–ª—é—Ç–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞—Ä–∞–Ω–µ–µ
- –ù—É–∂–Ω–∞ –æ—Ü–µ–Ω–∫–∞ –∫—É—Ä—Å–∞
- –°–ª–æ–∂–Ω–µ–µ UX

### 2. –ê–≤—Ç–æ–≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ **Auto Withdrawal** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–≤–æ–¥–∞ –Ω–∞ –∫–æ—à–µ–ª–µ–∫:
- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –∏–ª–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: $10-50
- –ò–∑–±–µ–≥–∞–π—Ç–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ NOWPayments

### 3. Multi-currency –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ —Ç–æ–ø –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã:
- **USDT TRC20** - –Ω–∏–∑–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ —Å–µ—Ç–∏
- **TON** - –¥–ª—è Telegram –∞—É–¥–∏—Ç–æ—Ä–∏–∏
- **BTC** - –¥–ª—è Bitcoin-–º–∞–∫—Å–∏–º–∞–ª–∏—Å—Ç–æ–≤
- **ETH** - –¥–ª—è Ethereum —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã

### 4. –§–∏–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Å–∏—é –∫—Ä–∏–ø—Ç—ã –≤ —Ñ–∏–∞—Ç:
- –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
- –°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥
- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è

---

## üêõ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "API key invalid"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á (Sandbox vs Production)
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω –≤ Dashboard

### –ü—Ä–æ–±–ª–µ–º–∞: "IPN signature verification failed"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `NOWPAYMENTS_IPN_SECRET` –≤ .env
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ raw request body –¥–ª—è signature
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ header: `x-nowpayments-sig`

### –ü—Ä–æ–±–ª–µ–º–∞: "Minimum amount not met"

**–†–µ—à–µ–Ω–∏–µ:**
- –ú–∏–Ω–∏–º—É–º: ~$1 (0.003 BTC —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç)
- –£–≤–µ–ª–∏—á—å—Ç–µ —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è NOWPayments —Å:
- ‚úÖ 300+ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç + 75 —Ñ–∏–∞—Ç–Ω—ã—Ö –≤–∞–ª—é—Ç
- ‚úÖ –ö–æ–º–∏—Å—Å–∏—è 0.5-1% (–≤ 6 —Ä–∞–∑ –¥–µ—à–µ–≤–ª–µ Stripe!)
- ‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ Invoice management
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ—Ö–≤–∞—Ç (–≤–∫–ª—é—á–∞—è –†–§)

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –î–æ–±–∞–≤–∏—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ (–Æ–öassa/CloudPayments) –¥–ª—è —Ñ–∏–∞—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π! üöÄ
